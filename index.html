<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Livo - Social Network</title>
    <style>
        :root {
            /* COMFORTABLE DARK MODE THEME */
            --bg-color: #000000;
            --card-bg: #000000;
            --text-main: #e7e9ea;
            --text-sec: #71767b;
            --accent: #1d9bf0;
            --accent-hover: #1a8cd8;
            --border: #2f3336;
            --hover-bg: rgba(255, 255, 255, 0.03);
            --mention-color: #58a6ff; /* Light Blue for mentions */
            
            /* Mood Colors */
            --mood-normal: #333333;
            --mood-sunny: #e6b800; 
            --mood-night: #1da1f2;
            --mood-chill: #00ba7c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); color: var(--text-main); overflow-x: hidden; padding-top: 100px; padding-bottom: 70px; }
        
        button { cursor: pointer; border: none; outline: none; background: transparent; color: inherit; transition: 0.2s; }
        input[type="text"], input[type="password"], input[type="email"], input[type="tel"], textarea, select { width: 100%; background: black; border:1px solid var(--border); color: var(--text-main); padding: 12px; border-radius: 4px; font-size: 15px; transition: 0.2s; }
        input:focus, textarea:focus, select:focus { border-color: var(--accent); outline: none; background: #000; }
        input[type="file"] { display: none; }

        /* TOAST NOTIFICATIONS */
        #toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 300px; pointer-events: none; }
        .toast { background: var(--accent); color: white; padding: 12px 20px; border-radius: 4px; font-size: 14px; font-weight: 600; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3); opacity: 0; transform: translateY(20px); transition: all 0.3s ease; pointer-events: auto; border: 1px solid rgba(255,255,255,0.1); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background: #f4212e; }

        /* AUTH SCREENS */
        .auth-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; padding: 20px; background: black; }
        .auth-box { width: 100%; max-width: 400px; }
        .auth-title { font-size: 32px; font-weight: 900; margin-bottom: 30px; color: var(--text-main); text-align: center; letter-spacing: -1px; }
        .auth-input { margin-bottom: 12px; border-radius: 4px; background: black; border:1px solid var(--border); }
        .auth-btn { background: var(--text-main); color: black; font-weight: 900; padding: 15px; border-radius: 20px; width: 100%; font-size: 16px; margin-top: 10px; }
        .toggle-auth { margin-top: 20px; color: var(--text-sec); font-size: 14px; text-align: center; }
        .toggle-auth a { color: var(--accent); cursor: pointer; font-weight: bold; text-decoration: none; }
        .forgot-pass { display: block; text-align: right; margin-top:5px; color: var(--accent); font-size: 13px; text-decoration: none; cursor: pointer; }

        /* HEADER & TOP NAV */
        .sticky-header { position: fixed; top: 0; left: 0; width: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); z-index: 100; border-bottom: 1px solid var(--border); }
        .app-header { padding: 12px 15px; display: flex; align-items: center; gap: 15px; justify-content: space-between; }
        .logo { font-size: 24px; font-weight: 900; color: var(--text-main); letter-spacing: -1px; cursor: pointer; }
        
        .search-container { flex: 1; margin: 0 10px; position: relative; }
        .search-input { background: #202327; border: 1px solid transparent; padding: 10px 15px 10px 40px; border-radius: 20px; width: 100%; color: white; font-size: 14px; }
        .search-input:focus { background: black; border-color: var(--accent); }
        .search-icon { position: absolute; left: 12px; top: 10px; color: var(--text-sec); pointer-events: none; }

        .top-nav { display: flex; justify-content: space-around; padding: 5px 0; border-bottom: 1px solid var(--border); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sec); padding: 8px; width: 20%; position: relative; cursor: pointer; transition: color 0.2s; }
        .nav-item svg { width: 24px; height: 24px; fill: currentColor; transition: fill 0.2s; }
        .nav-item.active { color: var(--text-main); }
        .nav-item.active svg { fill: var(--accent); }

        /* MENU DROPDOWN */
        .menu-btn { font-size: 20px; color: var(--text-main); padding: 8px; border-radius: 50%; }
        .dropdown-menu { position: absolute; top: 60px; right: 15px; background: black; border: 1px solid var(--border); border-radius: 12px; width: 220px; display: none; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 101; overflow: hidden; }
        .dropdown-menu.show { display: flex; animation: fadeIn 0.1s ease-out; }
        .menu-opt { padding: 14px 18px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 15px; color: var(--text-main); border-bottom: 1px solid #111; }
        .menu-opt:last-child { border-bottom: none; }
        .menu-opt:hover { background: rgba(255,255,255,0.05); }

        /* MAIN CONTENT */
        .container { max-width: 600px; margin: 0 auto; padding: 0 0; min-height: 80vh; }
        .view-section { display: none; animation: fadeIn 0.2s; }
        .view-section.active { display: block; }

        /* COMPOSER BOX */
        .cp-box { padding: 15px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; background: black; position: relative; z-index: 50; }
        .cp-top-row { display: flex; align-items: flex-start; gap: 12px; }
        .cp-avatar-sm { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); flex-shrink: 0; }
        
        .cp-input-container { flex: 1; display: flex; flex-direction: column; }
        .cp-input { border: none; background: transparent; font-size: 18px; color: var(--text-main); resize: none; outline: none; min-height: 40px; padding: 5px 0; width: 100%; font-family: inherit; }
        
        .cp-tools { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-left: 52px; }
        
        .cp-icons-group { display: flex; gap: 15px; }
        .cp-tool-btn { 
            display: flex; align-items: center; justify-content: center; 
            color: var(--accent); transition: 0.2s; gap: 4px; 
            border-radius: 50%; width: 34px; height: 34px;
        }
        .cp-tool-btn svg { width: 18px; height: 18px; fill: currentColor; }
        .cp-tool-btn:hover { background: rgba(29, 155, 240, 0.1); }
        
        .cp-btn { background: var(--accent); color: white; padding: 8px 24px; border-radius: 20px; font-weight: 900; font-size: 14px; opacity: 0.5; pointer-events: none; transition: 0.2s; white-space: nowrap; }
        .cp-btn.ready { opacity: 1; pointer-events: auto; }
        .cp-btn.ready:hover { background: var(--accent-hover); }

        /* MOOD SELECTOR */
        .mood-selector { display: flex; gap: 8px; margin-bottom: 5px; padding-left: 52px; }
        .mood-dot { width: 18px; height: 18px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.2s; opacity: 0.6; }
        .mood-dot.active { border-color: var(--text-main); opacity: 1; transform: scale(1.15); box-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .mood-normal { background: var(--mood-normal); }
        .mood-sunny { background: var(--mood-sunny); }
        .mood-night { background: var(--mood-night); }
        .mood-chill { background: var(--mood-chill); }

        /* POST CARD */
        .post-card { padding: 12px 12px 5px 12px; border-bottom: 1px solid var(--border); position: relative; cursor: default; transition: background 0.2s; }
        .post-card:hover { background: rgba(255,255,255,0.01); }
        
        /* Highlight for popular posts */
        .post-card.highlight { border-left: 3px solid var(--accent); background: rgba(29, 155, 240, 0.05); }

        .post-card[data-mood="sunny"] { border-left: 3px solid var(--mood-sunny); }
        .post-card[data-mood="night"] { border-left: 3px solid var(--mood-night); }
        .post-card[data-mood="chill"] { border-left: 3px solid var(--mood-chill); }

        .pc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .pc-user-info { display: flex; align-items: center; gap: 10px; }
        .pc-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 1px solid var(--border); flex-shrink: 0; }
        .pc-meta { display: flex; flex-direction: column; }
        
        .pc-top-line { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        
        .pc-name { font-weight: 600; color: var(--text-main); cursor: pointer; font-size: 15px; letter-spacing: -0.2px; } 
        .pc-name:hover { text-decoration: underline; text-decoration-color: var(--accent); }
        .pc-time { font-size: 12px; color: var(--text-sec); margin-left: 4px; }

        .follow-btn-small {
            background: transparent; border:1px solid var(--accent); color: var(--accent);
            padding: 4px 12px; border-radius: 18px; font-size: 13px; font-weight: 700; cursor: pointer;
            white-space: nowrap; margin-left: 8px; transition: 0.2s;
        }
        .follow-btn-small:hover { background: rgba(29, 155, 240, 0.1); }

        /* TEXT TRUNCATION LOGIC */
        .pc-text { font-size: 15px; line-height: 1.4; margin-bottom: 10px; margin-left: 0; white-space: pre-wrap; word-break: break-word; color: var(--text-main); cursor: text; }
        /* Hashtag & Mention styles */
        .highlight-text { color: var(--mention-color); cursor: pointer; font-weight: 500; }
        .highlight-text:hover { text-decoration: underline; }

        /* 7 Lines for Text Only */
        .post-text-clamped-7 {
            display: -webkit-box;
            -webkit-line-clamp: 7;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* 2 Lines for Media */
        .post-text-clamped-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .see-more { color: var(--accent); cursor: pointer; font-size: 13px; font-weight: bold; margin-top: 5px; display: none; user-select: none; }
        .limit-active-7 + .see-more, .limit-active-2 + .see-more { display: block; }

        /* MEDIA WRAPPERS */
        .pc-media-wrapper { 
            width: 100%; background: #000; border-radius: 8px; overflow: hidden; 
            position: relative; margin-bottom: 8px; border: 1px solid var(--border);
            cursor: pointer; 
        }
        .pc-media video { width: 100%; display: block; max-height: 600px; background: black; pointer-events: none; } 
        .pc-media img { width: 100%; display: block; pointer-events: none; }
        .pc-media-wrapper.vid-mode { aspect-ratio: 16/9; max-height: 500px; } 
        .pc-media-wrapper.img-mode { max-width: 100%; } 

        /* COMMENTS (Enhanced FB Lite Style) */
        .comments-section { margin-top: 10px; border-top: 1px solid var(--border); display: none; padding: 10px 0 5px 0; animation: fadeIn 0.2s; background: rgba(255,255,255,0.01); position: relative; z-index: 60; }
        .comments-section.open { display: block; }
        
        .comment-item { padding: 6px 0; display: flex; gap: 8px; font-size: 14px; width: 100%; box-sizing: border-box; }
        
        /* Circle Avatar for Comments */
        .comment-avatar { 
            width: 32px; height: 32px; 
            border-radius: 50%; object-fit: cover; flex-shrink: 0; cursor: pointer;
        }

        .comment-content-wrapper { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        
        .comment-bubble { 
            background: #3a3b3c; 
            padding: 8px 12px; 
            border-radius: 18px; 
            display: flex; 
            flex-direction: column; 
            position: relative;
            /* For long press effect */
            user-select: none; 
            -webkit-touch-callout: none;
        }
        
        .comment-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 2px; }
        .comment-author { font-weight: 600; font-size: 13px; color: var(--text-main); cursor: pointer; }
        .comment-author:hover { text-decoration: underline; }
        
        /* Mention Style inside comment */
        .mention-name {
            color: var(--mention-color);
            font-weight: 600;
            cursor: pointer;
        }
        .mention-name:hover { text-decoration: underline; }

        .comment-actions-row { font-size: 11px; color: var(--text-sec); display: flex; gap: 10px; margin-top: 2px; }
        .comment-action-btn { cursor: pointer; font-weight: 500; }
        .comment-action-btn:hover { color: var(--text-main); }

        .comment-reply-link { font-size: 12px; color: var(--accent); cursor: pointer; font-weight: 600; display: inline-block; margin-top: 4px;}
        .comment-reply-link:hover { text-decoration: underline; }
        
        /* Nested Replies (Indentation) */
        .reply-thread { margin-left: 36px; margin-top: 5px; border-left: 1px solid var(--border); padding-left: 10px; }

        .comment-input-wrapper { display: flex; gap: 8px; margin-top: 10px; align-items: center; position: relative; z-index: 70; }
        .comment-input { background: #3a3b3c; border: none; border-radius: 20px; padding: 8px 12px; font-size: 13px; color: white; width: 100%; font-family: inherit; }
        .comment-input:focus { background: #555; outline: none; }
        .comment-btn { background: var(--accent); color: white; border: none; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 800; }

        /* Long Press Menu */
        #context-menu { position: fixed; background: #2f3336; border-radius: 8px; padding: 5px 0; display: none; flex-direction: column; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.5); min-width: 150px; }
        .ctx-item { padding: 10px 15px; color: white; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .ctx-item:hover { background: var(--accent); }
        .ctx-item.delete { color: #ff4d4d; }

        /* ACTIONS */
        .pc-actions { display: flex; justify-content: space-around; align-items: center; width: 100%; margin-top: 4px; padding-top: 10px; border-top: 1px solid var(--border); }
        .action-item { display: flex; align-items: center; gap: 8px; color: var(--text-sec); font-size: 14px; cursor: pointer; padding: 8px 12px; border-radius: 4px; transition: 0.2s; position: relative; }
        .action-item:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
        .action-item:hover.like { color: #f91880; background: rgba(249, 24, 128, 0.05); }
        
        .action-item svg { width: 19px; height: 19px; fill: currentColor; transition: 0.2s; }
        .action-item.liked { color: #f91880 !important; }
        .action-item.liked svg { fill: #f91880; stroke: #f91880; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* PROFILE HEADER */
        .profile-header { padding: 0 0 20px 0; border-bottom: 1px solid var(--border); position: relative; }
        .cover-wrapper { position: relative; width: 100%; height: 150px; background: #1a1a1a; cursor: pointer; }
        .cover-pic { width: 100%; height: 100%; object-fit: cover; }
        .cover-upload-trigger { position: absolute; bottom: 10px; right: 10px; width: 32px; height: 32px; background: rgba(0,0,0,0.7); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; cursor: pointer; transition: background 0.2s; border: 1px solid rgba(255,255,255,0.2); }
        .profile-pic-wrapper { position: relative; display: inline-block; margin-top: -50px; margin-left: 15px; }
        .profile-pic { width: 120px; height: 120px; border-radius: 50%; border: 4px solid black; object-fit: cover; position: relative; z-index: 2; background: #1a1a1a; cursor: pointer; }
        .avatar-upload-trigger { position: absolute; bottom: 5px; right: 5px; width: 32px; height: 32px; background: rgba(0,0,0,0.7); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; transition: background 0.2s; border: 1px solid rgba(255,255,255,0.2); color: white; }
        .ph-details { padding: 10px 15px 0 15px; }
        .ph-top-row { display: flex; justify-content: space-between; align-items: flex-start; }
        .ph-name { font-size: 22px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 5px; flex-wrap: wrap; line-height: 1.2; }
        .ph-username { font-size: 14px; color: var(--text-sec); margin-top: 2px; }
        .ph-category { font-size: 14px; color: var(--accent); margin-top: 4px; font-weight: 600; } 
        
        .ph-meta-stats { display: flex; gap: 20px; margin: 12px 0; font-size: 14px; cursor: pointer; }
        .ph-stat-count { font-weight: bold; color: var(--text-main); }
        .ph-stat-label { color: var(--text-sec); }
        
        .ph-bio { color: var(--text-main); margin-bottom: 12px; font-size: 15px; line-height: 1.4; }
        .ph-meta { font-size: 14px; color: var(--text-sec); margin-bottom: 15px; display: flex; gap: 15px; align-items: center; }
        
        .profile-action-row { display: flex; gap: 10px; }
        .edit-btn { border: 1px solid var(--border); padding: 8px 16px; border-radius: 4px; font-weight: bold; font-size: 14px; min-width: 110px; text-align: center; transition: 0.2s; background: transparent; color: var(--text-main); }
        .edit-btn:hover { background: var(--hover-bg); border-color: var(--text-main); }
        
        .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-main); padding: 8px 16px; border-radius: 4px; font-weight: bold; font-size: 14px; cursor: pointer; }
        .btn-secondary:hover { background: #333; }

        .more-btn { background: transparent; color: var(--text-sec); font-size: 20px; cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; }
        .more-btn:hover { background: #333; color: white; }

        .profile-menu {
            position: absolute; top: 10px; right: 0; background: black;
            border: 1px solid var(--border); border-radius: 8px;
            display: none; flex-direction: column;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 20;
            min-width: 160px; overflow: hidden;
        }
        .profile-menu.show { display: flex; animation: fadeIn 0.1s; }
        .pm-item { padding: 12px 16px; cursor: pointer; font-size: 14px; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .pm-item:hover { background: rgba(255,255,255,0.05); }
        .pm-item.report { color: #f4212e; }

        /* SEARCH */
        .search-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 0; }
        .s-tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; border-bottom: 2px solid transparent; color: var(--text-sec); font-weight: 500; transition: 0.2s; }
        .s-tab.active { border-bottom-color: var(--accent); color: var(--accent); font-weight: bold; }
        .search-result-item { padding: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.1s; }
        .search-result-item:active { background: rgba(255,255,255,0.03); }

        /* SETTINGS PAGE */
        .settings-section { padding: 20px; border-bottom: 1px solid var(--border); }
        .settings-title { font-size: 18px; font-weight: 800; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .settings-group { margin-bottom: 20px; }
        .settings-group label { display: block; color: var(--text-sec); font-size: 12px; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
        .settings-btn { background: var(--accent); color: white; font-weight: bold; padding: 10px; width: 100%; border-radius: 4px; margin-top: 10px; }

        /* CHAT UI */
        #chat-input-row { display: flex; gap: 10px; padding: 10px 15px; border-top: 1px solid var(--border); align-items: center; background: black; position: fixed; bottom: 0; left: 0; width: 100%; max-width: 600px; margin: 0 auto; z-index: 90; box-sizing: border-box; }
        .chat-msg-container { padding: 15px; padding-bottom: 80px; overflow-y: auto; min-height: calc(100vh - 150px); display: flex; flex-direction: column; gap: 8px; }
        
        .msg-bubble { max-width: 75%; padding: 10px 16px; border-radius: 20px; margin-bottom: 4px; font-size: 15px; line-height: 1.4; word-wrap: break-word; position: relative; }
        .msg-sent { align-self: flex-end; background: var(--accent); color: white; border-bottom-right-radius: 4px; margin-left: auto; font-weight: 500; }
        .msg-received { align-self: flex-start; background: #333; color: white; border-bottom-left-radius: 4px; }
        
        .chat-list-item { padding: 15px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; cursor: pointer; }
        .chat-list-item:hover { background: rgba(255,255,255,0.03); }

        /* MODALS */
        .modal { position: fixed; bottom: 0; left: 0; width: 100%; background: black; border-top: 1px solid var(--border); z-index: 200; padding: 25px; display: none; flex-direction: column; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); border-radius: 20px 20px 0 0; box-shadow: 0 -5px 30px rgba(0,0,0,0.6); max-height: 90vh; overflow-y: auto; }
        .modal.open { display: flex; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-input-group { margin-bottom: 15px; }
        .modal-input-group label { display: block; color: var(--text-sec); font-size: 13px; margin-bottom: 5px; font-weight: 600; }

        /* IMAGE VIEWER */
        #img-viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 300; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #img-viewer img { max-width: 100%; max-height: 90%; object-fit: contain; }
        #img-viewer .close-btn { position: absolute; top: 20px; right: 20px; color: white; font-size: 40px; cursor: pointer; opacity: 0.8; background: rgba(0,0,0,0.5); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        .post-options-btn { color: var(--text-sec); cursor: pointer; padding: 8px; font-size: 20px; border-radius: 50%; }
        .post-options-btn:hover { background: rgba(255,255,255,0.05); }
        .post-menu { position: absolute; right: 10px; top: 50px; background: black; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: none; flex-direction: column; z-index: 10; overflow: hidden; width: 150px; }
        .post-menu.show { display: flex; animation: fadeIn 0.1s; }
        .post-menu .pm-item { padding: 12px 16px; cursor: pointer; font-size: 14px; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        .post-menu .pm-item:hover { background: rgba(255,255,255,0.05); }
        .post-menu .pm-item.delete { color: #f4212e; }

        .list-user-item { display: flex; align-items: center; gap: 10px; padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .list-user-item:hover { background: rgba(255,255,255,0.03); }
    </style>
</head>
<body>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- LOADING SCREEN -->
    <div id="auth-loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:black; color:white; display:flex; align-items:center; justify-content:center; z-index:9999;">
        <div style="text-align:center;">
            <div style="font-size:40px; margin-bottom:10px; color:var(--accent);">‚Ä¢</div>
            <h2 style="font-weight:900; font-size:24px; letter-spacing: -1px; color:white;">Livo</h2>
        </div>
    </div>

    <!-- IMAGE VIEWER MODAL -->
    <div id="img-viewer" onclick="this.style.display='none'">
        <div class="close-btn" onclick="event.stopPropagation(); document.getElementById('img-viewer').style.display='none'">√ó</div>
        <img id="viewer-img" src="" onclick="event.stopPropagation()">
    </div>

    <!-- AUTH SECTION -->
    <div id="auth-screen" class="auth-container" style="display:none;">
        <div class="auth-box">
            <div class="auth-title">Livo</div>
            
            <div id="login-form">
                <input type="text" id="l-user" class="auth-input" placeholder="Username, Email or Mobile">
                <input type="password" id="l-pass" class="auth-input" placeholder="Password">
                <a class="forgot-pass" onclick="app.forgotPassword()">Forgot Password?</a>
                <button class="auth-btn" onclick="app.login()">Log In</button>
                <div class="toggle-auth">Don't have an account? <a onclick="app.toggleAuth('register')">Sign up</a></div>
            </div>

            <div id="register-form" style="display:none;">
                <input type="text" id="r-name" class="auth-input" placeholder="Full Name">
                <input type="text" id="r-username" class="auth-input" placeholder="Username">
                <input type="email" id="r-email" class="auth-input" placeholder="Email">
                <input type="password" id="r-pass" class="auth-input" placeholder="Password">
                <button class="auth-btn" onclick="app.register()">Sign up</button>
                <div class="toggle-auth">Already have an account? <a onclick="app.toggleAuth('login')">Log in</a></div>
            </div>
        </div>
    </div>

    <!-- APP SECTION -->
    <div id="app-screen" style="display:none;">
        <div class="sticky-header">
            <div class="app-header">
                <div class="logo" onclick="app.navTo('home', true)">Livo</div>
                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" placeholder="Search" onkeyup="app.handleSearch(this.value)">
                </div>
                <button class="menu-btn" onclick="document.getElementById('main-menu').classList.toggle('show')">‚ò∞</button>
                <div id="main-menu" class="dropdown-menu">
                    <div class="menu-opt" onclick="app.navTo('profile'); document.getElementById('main-menu').classList.remove('show')">üë§ Profile</div>
                    <div class="menu-opt" onclick="app.navTo('settings'); document.getElementById('main-menu').classList.remove('show')">‚öôÔ∏è Settings</div>
                    <div class="menu-opt" onclick="document.getElementById('modal-edit-profile').classList.add('open'); document.getElementById('main-menu').classList.remove('show')">‚úèÔ∏è Edit Profile</div>
                    <div class="menu-opt" onclick="app.logout()">üö™ Log out</div>
                </div>
            </div>
            
            <div class="top-nav">
                <div class="nav-item active" onclick="app.navTo('home', true)" id="nav-home">
                    <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                </div>
                <div class="nav-item" onclick="app.navTo('video')" id="nav-video">
                    <svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                </div>
                <div class="nav-item" onclick="app.navTo('chat')" id="nav-chat">
                    <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                </div>
                <div class="nav-item" onclick="app.navTo('channel')" id="nav-channel">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                </div>
                <div class="nav-item" onclick="app.navTo('ping')" id="nav-ping">
                    <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
                </div>
            </div>
        </div>

        <div class="container">
            
            <!-- HOME VIEW -->
            <div id="view-home" class="view-section">
                <div class="cp-box">
                    <div class="cp-top-row">
                        <img id="home-avatar" class="cp-avatar-sm" src="" onclick="app.navTo('profile')">
                        <div class="cp-input-container">
                            <textarea id="home-post-input" class="cp-input" placeholder="What is on your mind?" oninput="app.checkPostBtn('home')"></textarea>
                            
                            <div class="mood-selector">
                                <div class="mood-dot mood-normal active" onclick="app.setMood('home', 'normal')" title="Normal"></div>
                                <div class="mood-dot mood-sunny" onclick="app.setMood('home', 'sunny')" title="Sunny"></div>
                                <div class="mood-dot mood-night" onclick="app.setMood('home', 'night')" title="Night"></div>
                                <div class="mood-dot mood-chill" onclick="app.setMood('home', 'chill')" title="Chill"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cp-tools">
                        <div class="cp-icons-group">
                            <label for="home-img-file" class="cp-tool-btn" title="Photo"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></label>
                            <label for="home-vid-file" class="cp-tool-btn" title="Video"><svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg></label>
                        </div>
                        <button class="cp-btn" id="home-post-btn" onclick="app.createPost('home')">Post</button>
                    </div>
                    <input type="file" id="home-img-file" accept="image/*" onchange="app.handleFileSelect('home', 'img', this)">
                    <input type="file" id="home-vid-file" accept="video/*" onchange="app.handleFileSelect('home', 'vid', this)">
                </div>
                <div id="home-feed"></div>
            </div>

            <!-- VIDEO VIEW -->
            <div id="view-video" class="view-section">
                <div id="video-feed"></div>
            </div>

            <!-- CHAT LIST VIEW -->
            <div id="view-chat" class="view-section">
                <h3 style="padding:15px; border-bottom:1px solid var(--border);">Messages</h3>
                <div id="chat-list"></div>
            </div>
            
             <!-- CHAT DETAIL VIEW -->
             <div id="view-chat-detail" class="view-section">
                <div style="padding:10px 15px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px; position:sticky; top:0; background:black; z-index:10;">
                    <button onclick="app.navTo('chat')" style="font-size:20px;">‚¨Ö</button>
                    <div id="chat-header-name" style="font-weight:bold; font-size:16px;">User</div>
                </div>
                <div id="chat-messages" class="chat-msg-container"></div>
                <div id="chat-input-row">
                    <input type="text" id="chat-input" placeholder="Message..." style="background:#202327; border-radius:20px; border:none; padding:10px 15px;">
                    <button class="cp-btn" style="opacity:1; border-radius:50%; width:40px; height:40px; padding:0; display:flex; align-items:center; justify-content:center;" onclick="app.sendMessage()">‚û§</button>
                </div>
            </div>

            <!-- SEARCH RESULTS VIEW -->
            <div id="view-search" class="view-section">
                <div class="search-tabs">
                    <div class="s-tab active" onclick="app.switchSearchTab('all')">All</div>
                </div>
                <div id="search-results-list"></div>
            </div>

            <!-- SETTINGS VIEW -->
            <div id="view-settings" class="view-section">
                <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; font-size:18px; display:flex; justify-content:space-between;">
                    <span>Settings</span>
                    <span onclick="app.navTo('home')" style="cursor:pointer;">‚úï</span>
                </div>
                
                <div class="settings-section">
                    <div class="settings-title">üîí Account Security</div>
                    
                    <div class="settings-group">
                        <label>Email Address</label>
                        <input type="email" id="set-email" class="auth-input">
                    </div>
                    
                    <div class="settings-group">
                        <label>Mobile Number</label>
                        <input type="tel" id="set-mobile" class="auth-input" placeholder="+8801...">
                    </div>

                    <div class="settings-group">
                        <label>Old Password</label>
                        <input type="password" id="set-old-pass" class="auth-input" placeholder="Required to change password">
                    </div>
                    
                    <div class="settings-group">
                        <label>New Password</label>
                        <input type="password" id="set-pass" class="auth-input" placeholder="Leave blank to keep current">
                    </div>
                    
                    <button class="settings-btn" onclick="app.updateAccountSettings()">Update Changes</button>
                </div>

                <div class="settings-section">
                    <div class="settings-title">üåê Verification</div>
                    <div style="color:var(--text-sec); font-size:14px; margin-bottom:15px;">
                        Verify your email to secure your account.
                    </div>
                    <button class="settings-btn" onclick="app.sendVerificationEmail()">Send Verification Email</button>
                </div>
            </div>

            <!-- PROFILE VIEW -->
            <div id="view-profile" class="view-section">
                <div id="profile-header-content"></div>
                <div class="cp-box" id="profile-post-box" style="display:none;">
                    <div class="cp-top-row">
                        <img id="profile-avatar" class="cp-avatar-sm" src="" onclick="app.navTo('profile')">
                        <div class="cp-input-container">
                            <textarea id="profile-post-input" class="cp-input" placeholder="What is on your mind?" oninput="app.checkPostBtn('profile')"></textarea>
                            <div class="mood-selector">
                                <div class="mood-dot mood-normal active" onclick="app.setMood('profile', 'normal')"></div>
                                <div class="mood-dot mood-sunny" onclick="app.setMood('profile', 'sunny')"></div>
                                <div class="mood-dot mood-night" onclick="app.setMood('profile', 'night')"></div>
                                <div class="mood-dot mood-chill" onclick="app.setMood('profile', 'chill')"></div>
                            </div>
                        </div>
                    </div>
                    <div class="cp-tools">
                        <div class="cp-icons-group">
                            <label for="profile-img-file" class="cp-tool-btn"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></label>
                            <label for="profile-vid-file" class="cp-tool-btn"><svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg></label>
                        </div>
                        <button class="cp-btn" id="profile-post-btn" onclick="app.createPost('profile')">Post</button>
                    </div>
                    <input type="file" id="profile-img-file" accept="image/*" onchange="app.handleFileSelect('profile', 'img', this)">
                    <input type="file" id="profile-vid-file" accept="video/*" onchange="app.handleFileSelect('profile', 'vid', this)">
                </div>
                <div id="profile-feed"></div>
            </div>

            <!-- CHANNEL VIEW -->
            <div id="view-channel" class="view-section">
                <div id="channel-header-content"></div>
                <div class="cp-box" id="channel-post-box" style="display:none;">
                    <div class="cp-top-row">
                        <img id="channel-avatar" class="cp-avatar-sm" src="">
                        <div class="cp-input-container">
                            <textarea id="channel-post-input" class="cp-input" placeholder="Broadcast to Channel..." oninput="app.checkPostBtn('channel')"></textarea>
                             <div class="mood-selector">
                                <div class="mood-dot mood-normal active" onclick="app.setMood('channel', 'normal')"></div>
                                <div class="mood-dot mood-sunny" onclick="app.setMood('channel', 'sunny')"></div>
                                <div class="mood-dot mood-night" onclick="app.setMood('channel', 'night')"></div>
                                <div class="mood-dot mood-chill" onclick="app.setMood('channel', 'chill')"></div>
                            </div>
                        </div>
                    </div>
                    <div class="cp-tools">
                        <div class="cp-icons-group">
                            <label for="channel-img-file" class="cp-tool-btn"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></label>
                            <label for="channel-vid-file" class="cp-tool-btn"><svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg></label>
                        </div>
                        <button class="cp-btn" id="channel-post-btn" onclick="app.createPost('channel')">Post</button>
                    </div>
                    <input type="file" id="channel-img-file" accept="image/*" onchange="app.handleFileSelect('channel', 'img', this)">
                    <input type="file" id="channel-vid-file" accept="video/*" onchange="app.handleFileSelect('channel', 'vid', this)">
                </div>
                <div id="channel-feed"></div>
            </div>

            <div id="view-channel-list" class="view-section">
                <div style="display:flex; justify-content:space-between; align-items:center; padding:15px;">
                    <h3 style="font-size:18px;" id="channel-list-title">Channels</h3>
                    <button class="cp-btn" style="opacity:1; pointer-events:auto; font-size:14px; padding:6px 15px;" onclick="app.openCreateChannel()">+ Create</button>
                </div>
                <div id="all-channels-list"></div>
            </div>

             <div id="view-ping" class="view-section">
                <h3 style="padding:15px; border-bottom:1px solid var(--border); font-size:18px;">Notifications</h3>
                <div id="ping-list"></div>
            </div>

        </div>
    </div>

    <!-- CONTEXT MENU (Long Press) -->
    <div id="context-menu">
        <div class="ctx-item" onclick="app.ctxAction('edit')">‚úèÔ∏è Edit</div>
        <div class="ctx-item" onclick="app.ctxAction('delete')">üóëÔ∏è Delete</div>
        <div class="ctx-item" onclick="app.ctxAction('report')">‚ö†Ô∏è Report</div>
    </div>

    <!-- MODAL: CREATE CHANNEL -->
    <div id="modal-create-channel" class="modal">
        <div class="modal-head" style="font-size:18px; font-weight:bold; margin-bottom:15px; display:flex; justify-content:space-between;">
            <span>Create Channel</span>
            <span onclick="document.getElementById('modal-create-channel').classList.remove('open')" style="cursor:pointer;">‚úï</span>
        </div>
        <input type="text" id="new-chan-name" class="auth-input" placeholder="Channel Name">
        <div class="modal-input-group">
            <label>Username (handle)</label>
            <input type="text" id="new-chan-username" class="auth-input" placeholder="@channelname">
        </div>
        <div class="modal-input-group">
            <label>Category</label>
            <select id="new-chan-category" class="auth-input">
                <option value="News">News</option>
                <option value="Sports">Sports</option>
                <option value="Public Vibes">Public Vibes</option>
                <option value="Personal">Personal</option>
                <option value="Video Maker">Video Maker</option>
                <option value="Entertainment">Entertainment</option>
                <option value="Technology">Technology</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <textarea id="new-chan-bio" class="auth-input" placeholder="Description" rows="3"></textarea>
        <button class="auth-btn" onclick="app.submitCreateChannel()">Create</button>
    </div>

    <!-- MODAL: EDIT CHANNEL -->
    <div id="modal-edit-channel" class="modal">
        <div class="modal-head" style="font-size:18px; font-weight:bold; margin-bottom:15px; display:flex; justify-content:space-between;">
            <span>Edit Channel</span>
            <span onclick="document.getElementById('modal-edit-channel').classList.remove('open')" style="cursor:pointer;">‚úï</span>
        </div>
        <input type="hidden" id="edit-chan-id">
        <input type="text" id="edit-chan-name" class="auth-input" placeholder="Channel Name">
        <div class="modal-input-group">
            <label>Username</label>
            <input type="text" id="edit-chan-username" class="auth-input" placeholder="@channelname">
        </div>
        <div class="modal-input-group">
            <label>Category</label>
            <select id="edit-chan-category" class="auth-input">
                <option value="News">News</option>
                <option value="Sports">Sports</option>
                <option value="Public Vibes">Public Vibes</option>
                <option value="Personal">Personal</option>
                <option value="Video Maker">Video Maker</option>
                <option value="Entertainment">Entertainment</option>
                <option value="Technology">Technology</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <textarea id="edit-chan-bio" class="auth-input" placeholder="Description" rows="3"></textarea>
        <button class="auth-btn" onclick="app.submitEditChannel()">Save Changes</button>
    </div>

    <!-- MODAL: EDIT PROFILE -->
    <div id="modal-edit-profile" class="modal">
        <div class="modal-head" style="font-size:18px; font-weight:bold; margin-bottom:15px; display:flex; justify-content:space-between;">
            <span>Edit Profile</span>
            <span onclick="document.getElementById('modal-edit-profile').classList.remove('open')" style="cursor:pointer;">‚úï</span>
        </div>
        <div class="modal-input-group">
            <label>Name</label>
            <input type="text" id="edit-name" class="auth-input">
        </div>
        <div class="modal-input-group">
            <label>Bio</label>
            <textarea id="edit-bio" class="auth-input" rows="3"></textarea>
        </div>
        <div class="modal-input-group">
            <label>Location</label>
            <input type="text" id="edit-location" class="auth-input">
        </div>
        <div class="modal-input-group">
            <label>Website</label>
            <input type="text" id="edit-website" class="auth-input">
        </div>
        <button class="auth-btn" onclick="app.saveProfileChanges()">Save</button>
    </div>

    <!-- MODAL: FOLLOWERS/FOLLOWING -->
    <div id="modal-users-list" class="modal">
        <div class="modal-head" style="font-size:18px; font-weight:bold; margin-bottom:15px; display:flex; justify-content:space-between;">
            <span id="modal-users-title">List</span>
            <span onclick="document.getElementById('modal-users-list').classList.remove('open')" style="cursor:pointer;">‚úï</span>
        </div>
        <div id="modal-users-content"></div>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateEmail, updatePassword, sendEmailVerification, sendPasswordResetEmail, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, query, where, onSnapshot, orderBy, setDoc, getDoc, getDocs, arrayUnion, arrayRemove, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-storage.js";

        // ==========================================
        // CONFIG
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAKqNt9KLTVy3OXiLVmJGyADzdnQQ_cASE",
            authDomain: "livoapp-dc2da.firebaseapp.com",
            projectId: "livoapp-dc2da",
            storageBucket: "livoapp-dc2da.firebasestorage.app",
            messagingSenderId: "178266701059",
            appId: "1:178266701059:web:23775265b7dc81b765fd36",
            measurementId: "G-6Y6VZZ6RHR"
        };

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const storage = getStorage(fbApp);

        let currentUserData = null; 
        let activeListeners = [];
        let pendingFiles = {};
        let pendingMoods = {}; 
        let currentChatUserId = null;
        let currentChatId = null;
        let savedPosts = [];
        
        // Context Menu State
        let ctxPostId = null;
        let ctxCommentObj = null;

        // Track replying state
        let replyingState = {}; 

        const app = {
            state: { currentView: 'home', viewingProfileId: null, viewingChannelId: null, searchTab: 'all' },

            init: function() {
                onAuthStateChanged(auth, async (user) => {
                    const loader = document.getElementById('auth-loader');
                    if(loader) loader.style.display = 'none';

                    if (user) {
                        await this.loadUserProfile(user.uid);
                    } else {
                        document.getElementById('auth-screen').style.display = 'flex';
                        document.getElementById('app-screen').style.display = 'none';
                        this.cleanupListeners();
                    }
                });
            },

            showToast: function(message, type = 'normal') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type === 'error' ? 'error' : ''}`;
                toast.innerHTML = type === 'error' ? `‚ö†Ô∏è ${message}` : `‚úì ${message}`;
                container.appendChild(toast);
                
                requestAnimationFrame(() => {
                    toast.classList.add('show');
                });

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            cleanupListeners: function() {
                activeListeners.forEach(unsub => unsub());
                activeListeners = [];
            },

            loadUserProfile: async function(uid) {
                const docRef = doc(db, "users", uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    currentUserData = { id: docSnap.id, ...docSnap.data() };
                    // Ensure arrays exist
                    if(!currentUserData.following) currentUserData.following = [];
                    if(!currentUserData.followers) currentUserData.followers = [];
                    if(!currentUserData.followingChannels) currentUserData.followingChannels = [];
                    if(currentUserData.bookmarks) savedPosts = currentUserData.bookmarks;
                    this.listenToNotifications();
                    this.showApp();
                } else {
                    alert("User data error. Please contact support.");
                    signOut(auth);
                }
            },

            toggleAuth: (type) => {
                document.getElementById('login-form').style.display = type === 'login' ? 'block' : 'none';
                document.getElementById('register-form').style.display = type === 'register' ? 'block' : 'none';
            },

            forgotPassword: async function() {
                const input = document.getElementById('l-user').value.trim();
                if(!input) return this.showToast("Enter your email or username first", 'error');
                
                let email = input;
                if(!input.includes('@')) {
                    const q = query(collection(db, "users"), where("username", "==", input.toLowerCase()));
                    const snap = await getDocs(q);
                    if(snap.empty) return this.showToast("User not found", 'error');
                    email = snap.docs[0].data().email;
                }
                
                try {
                    await sendPasswordResetEmail(auth, email);
                    this.showToast("Password reset email sent");
                } catch(e) {
                    this.showToast("Error sending email", 'error');
                }
            },

            login: async function() {
                const input = document.getElementById('l-user').value.trim(); 
                const pass = document.getElementById('l-pass').value.trim();
                
                if(!input || !pass) return this.showToast("Please fill all fields", 'error');

                let emailToUse = input;

                if (!input.includes('@')) {
                    try {
                        const q = query(collection(db, "users"), where("username", "==", input.toLowerCase()));
                        const snap = await getDocs(q);
                        if (snap.empty) {
                            return this.showToast("User not found", 'error');
                        }
                        emailToUse = snap.docs[0].data().email;
                    } catch (e) {
                        return this.showToast("Error finding user", 'error');
                    }
                }

                try {
                    await signInWithEmailAndPassword(auth, emailToUse, pass);
                } catch (error) {
                    this.showToast("Login failed", 'error');
                }
            },

            register: async function() {
                const name = document.getElementById('r-name').value.trim();
                const username = document.getElementById('r-username').value.trim();
                const email = document.getElementById('r-email').value.trim();
                const pass = document.getElementById('r-pass').value.trim();

                if(!name || !username || !email || !pass) return this.showToast("All fields required", 'error');
                if(username.includes(' ')) return this.showToast("Username cannot contain spaces", 'error');

                try {
                    const q = query(collection(db, "users"), where("username", "==", username.toLowerCase()));
                    const snap = await getDocs(q);
                    if(!snap.empty) return this.showToast("Username is taken", 'error');

                    const cred = await createUserWithEmailAndPassword(auth, email, pass);

                    const newUser = {
                        uid: cred.user.uid,
                        email: email,
                        name: name,
                        username: username.toLowerCase(), 
                        bio: "", 
                        location: "",
                        website: "",
                        mobile: "",
                        avatar: `https://picsum.photos/seed/${cred.user.uid}/200/200`, 
                        cover: `https://picsum.photos/seed/${cred.user.uid}cover/600/200`,
                        following: [],
                        followers: [],
                        bookmarks: [],
                        followingChannels: []
                    };
                    await setDoc(doc(db, "users", cred.user.uid), newUser);
                } catch (error) {
                    this.showToast(error.message, 'error');
                }
            },

            logout: () => signOut(auth),

            showApp: function() {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'block';
                document.getElementById('home-avatar').src = currentUserData.avatar;
                
                document.getElementById('set-email').value = currentUserData.email;
                document.getElementById('set-mobile').value = currentUserData.mobile || "";

                this.navTo('home');
            },

            navTo: function(viewName, refresh = false) {
                if(viewName === 'home' && refresh) {
                    this.showToast("Refreshing feed...", 'normal');
                    // Force reload effect by briefly hiding feed
                    document.getElementById('home-feed').innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-sec)">Loading...</div>';
                }

                this.state.currentView = viewName;
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const navEl = document.getElementById('nav-' + viewName);
                if(navEl) navEl.classList.add('active');
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                
                this.cleanupListeners();

                if(viewName === 'home') { 
                    document.getElementById('view-home').classList.add('active'); 
                    this.listenToFeed('home'); 
                } else if (viewName === 'video') { 
                    document.getElementById('view-video').classList.add('active'); 
                    this.listenToFeed('video'); 
                } else if (viewName === 'chat') { 
                    document.getElementById('view-chat').classList.add('active'); 
                    this.loadChatList(); 
                } else if (viewName === 'channel') { 
                    document.getElementById('view-channel-list').classList.add('active'); 
                    this.listenToChannels(); 
                } else if (viewName === 'ping') { 
                    document.getElementById('view-ping').classList.add('active'); 
                } else if (viewName === 'profile') { 
                    this.openProfile(currentUserData.id); 
                } else if (viewName === 'search') { 
                    document.getElementById('view-search').classList.add('active'); 
                } else if (viewName === 'settings') {
                    document.getElementById('view-settings').classList.add('active');
                }
                
                document.getElementById('main-menu').classList.remove('show');
            },

            updateAccountSettings: async function() {
                const newEmail = document.getElementById('set-email').value;
                const newMobile = document.getElementById('set-mobile').value;
                const oldPass = document.getElementById('set-old-pass').value;
                const newPass = document.getElementById('set-pass').value;

                try {
                    if(newPass) {
                        if(!oldPass) return this.showToast("Enter old password to change password", 'error');
                        const credential = EmailAuthProvider.credential(auth.currentUser.email, oldPass);
                        await reauthenticateWithCredential(auth.currentUser, credential);
                        await updatePassword(auth.currentUser, newPass);
                        this.showToast("Password updated");
                        document.getElementById('set-old-pass').value = "";
                        document.getElementById('set-pass').value = "";
                    }

                    if(newEmail !== currentUserData.email) {
                        await updateEmail(auth.currentUser, newEmail);
                        currentUserData.email = newEmail;
                        await updateDoc(doc(db, "users", currentUserData.id), { email: newEmail });
                    }
                    if(newMobile !== currentUserData.mobile) {
                        await updateDoc(doc(db, "users", currentUserData.id), { mobile: newMobile });
                        currentUserData.mobile = newMobile;
                    }
                    
                    if(!newPass && newEmail === currentUserData.email && newMobile === currentUserData.mobile) {
                         this.showToast("No changes made");
                    }
                } catch(e) {
                    this.showToast("Update failed: " + e.message, 'error');
                }
            },

            sendVerificationEmail: async function() {
                try {
                    await sendEmailVerification(auth.currentUser);
                    this.showToast("Verification email sent");
                } catch(e) {
                    this.showToast("Failed to send email", 'error');
                }
            },

            handleFileSelect: function(context, type, fileInput) {
                const file = fileInput.files[0];
                if(!file) return;
                const btn = document.getElementById(context + '-post-btn');
                
                if(type === 'img') document.getElementById(context + '-vid-file').value = "";
                if(type === 'vid') document.getElementById(context + '-img-file').value = "";
                
                pendingFiles[context] = file;
                btn.dataset.fileType = type; 
                btn.dataset.hasFile = "true";
                btn.classList.add('ready');
            },

            setMood: function(context, mood) {
                pendingMoods[context] = mood;
                const container = document.querySelector(`#${context === 'home' ? 'view-home' : (context === 'profile' ? 'view-profile' : 'view-channel')} .mood-selector`);
                Array.from(container.children).forEach(dot => dot.classList.remove('active'));
                container.querySelector(`.mood-${mood}`).classList.add('active');
            },

            openEditProfileModal: function() {
                document.getElementById('edit-name').value = currentUserData.name;
                document.getElementById('edit-bio').value = currentUserData.bio;
                document.getElementById('edit-location').value = currentUserData.location || '';
                document.getElementById('edit-website').value = currentUserData.website || '';
                document.getElementById('modal-edit-profile').classList.add('open');
            },

            saveProfileChanges: async function() {
                const newName = document.getElementById('edit-name').value;
                const newBio = document.getElementById('edit-bio').value;
                const newLoc = document.getElementById('edit-location').value;
                const newWeb = document.getElementById('edit-website').value;
                if(!newName) return this.showToast("Name required", 'error');

                try {
                    const userRef = doc(db, "users", currentUserData.id);
                    await updateDoc(userRef, {
                        name: newName,
                        bio: newBio,
                        location: newLoc,
                        website: newWeb
                    });
                    
                    currentUserData.name = newName;
                    currentUserData.bio = newBio;
                    currentUserData.location = newLoc;
                    currentUserData.website = newWeb;

                    document.getElementById('modal-edit-profile').classList.remove('open');
                    this.openProfile(currentUserData.id);
                    this.showToast("Profile updated");
                } catch(e) {
                    this.showToast("Update failed", 'error');
                }
            },

            clearFile: function(context) {
                const btn = document.getElementById(context + '-post-btn');
                document.getElementById(context + '-img-file').value = "";
                document.getElementById(context + '-vid-file').value = "";
                delete pendingFiles[context];
                delete btn.dataset.fileType;
                delete btn.dataset.hasFile;
                btn.classList.remove('ready');
                this.setMood(context, 'normal');
            },

            checkPostBtn: function(context) {
                const text = document.getElementById(context + '-post-input').value;
                const btn = document.getElementById(context + '-post-btn');
                if(text.trim().length > 0 || btn.dataset.hasFile) {
                    btn.classList.add('ready');
                } else {
                    if(!btn.dataset.hasFile) btn.classList.remove('ready');
                }
            },

            createPost: async function(context) {
                let text="", media=null, type='post', isChannel=false, channelId=null, authorName=currentUserData.name, authorId=currentUserData.id, authorUsername=currentUserData.username; 
                
                if(context === 'home') { text = document.getElementById('home-post-input').value; } 
                else if (context === 'profile') { text = document.getElementById('profile-post-input').value; isChannel=false; } 
                else if (context === 'channel') { 
                    text = document.getElementById('channel-post-input').value;
                    channelId = this.state.viewingChannelId; 
                    const snap = await getDoc(doc(db, "channels", channelId));
                    if(snap.exists()) {
                        authorName = snap.data().name; 
                    }
                    isChannel = true; 
                }
                
                const btn = document.getElementById(context + '-post-btn');
                const mood = pendingMoods[context] || 'normal';

                // Handle Channel Avatar in Feed
                let postAvatarUrl = null;
                if (isChannel && channelId) {
                    const cSnap = await getDoc(doc(db, "channels", channelId));
                    if (cSnap.exists()) postAvatarUrl = cSnap.data().avatar;
                }

                if(btn.dataset.hasFile) {
                    const file = pendingFiles[context];
                    const fileType = btn.dataset.fileType;
                    
                    try {
                        this.showToast("Uploading...");
                        const fileName = `${context}_${Date.now()}_${file.name}`;
                        const storageRef = ref(storage, `posts/${fileName}`);
                        await uploadBytes(storageRef, file);
                        media = await getDownloadURL(storageRef);
                        type = fileType === 'vid' ? 'video' : 'post';
                    } catch (error) {
                        this.showToast("Upload failed", 'error');
                        return;
                    }
                }

                if(!text && !media) return this.showToast("Empty content", 'error');

                const newPost = { 
                    authorId, authorName, authorUsername, isChannel, channelId, postAvatarUrl,
                    content: text, media, type, 
                    likes: 0, likedBy: [], comments: [], 
                    timestamp: Date.now(),
                    mood: mood,
                    views: 0 // Simple view counter
                };

                try {
                    await addDoc(collection(db, "posts"), newPost);
                    this.showToast("Posted!");
                    
                    if(context === 'home') { document.getElementById('home-post-input').value = ""; this.clearFile('home'); }
                    if(context === 'profile') { document.getElementById('profile-post-input').value = ""; this.clearFile('profile'); }
                    if(context === 'channel') { document.getElementById('channel-post-input').value = ""; this.clearFile('channel'); }
                } catch(e) { 
                    this.showToast("Error posting", 'error');
                }
            },

            deletePost: async function(postId) {
                if(!confirm("Delete this post?")) return;
                try {
                    await deleteDoc(doc(db, "posts", postId));
                    this.showToast("Post deleted");
                } catch(e) {
                    this.showToast("Could not delete", 'error');
                }
            },

            editPost: async function(postId) {
                const newText = prompt("Edit caption:", ""); 
                if(newText !== null) {
                    await updateDoc(doc(db, "posts", postId), { content: newText });
                    this.showToast("Caption updated");
                }
            },

            toggleLike: async function(postId, btnElement) {
                const postRef = doc(db, "posts", postId);
                const uid = currentUserData.id;
                
                const isLikedNow = btnElement.classList.contains('liked');
                const countSpan = btnElement.querySelector('span');
                let newCount = parseInt(countSpan.innerText);

                if(!isLikedNow) {
                    btnElement.classList.add('liked');
                    countSpan.innerText = newCount + 1;
                } else {
                    btnElement.classList.remove('liked');
                    countSpan.innerText = Math.max(0, newCount - 1);
                }

                try {
                    const snap = await getDoc(postRef);
                    if(snap.exists()) {
                        const data = snap.data();
                        const likes = data.likedBy || [];
                        if(likes.includes(uid)) {
                            await updateDoc(postRef, { likedBy: arrayRemove(uid), likes: (data.likes ||1) - 1 });
                        } else {
                            await updateDoc(postRef, { likedBy: arrayUnion(uid), likes: (data.likes ||0) + 1 });
                            
                            // Notify Post Owner
                            if(data.authorId !== uid && !data.isChannel) {
                                this.addNotification(data.authorId, 'like', `${currentUserData.name} liked your post.`);
                            }
                        }
                    }
                } catch (e) {
                    if(!isLikedNow) btnElement.classList.remove('liked');
                    else btnElement.classList.add('liked');
                    countSpan.innerText = newCount;
                }
            },

            toggleSave: async function(postId) {
                const userRef = doc(db, "users", currentUserData.id);
                if(savedPosts.includes(postId)) {
                    await updateDoc(userRef, { bookmarks: arrayRemove(postId) });
                    savedPosts = savedPosts.filter(id => id !== postId);
                    this.showToast("Removed from Bookmarks");
                } else {
                    await updateDoc(userRef, { bookmarks: arrayUnion(postId) });
                    savedPosts.push(postId);
                    this.showToast("Saved to Bookmarks");
                }
            },

            addNotification: async function(toUserId, type, text) {
                await addDoc(collection(db, "notifications"), {
                    toUserId, type, text, timestamp: Date.now(), read: false
                });
            },

            listenToNotifications: function() {
                const list = document.getElementById('ping-list');
                const q = query(collection(db, "notifications"), where("toUserId", "==", currentUserData.id), orderBy("timestamp", "desc"));
                
                const unsub = onSnapshot(q, (snapshot) => {
                    list.innerHTML = '';
                    if(snapshot.empty) {
                        list.innerHTML = "<div style='padding:20px; text-align:center; color:#777;'>No notifications</div>";
                        return;
                    }
                    snapshot.forEach(doc => {
                        const n = doc.data();
                        const timeStr = this.timeAgo(n.timestamp);
                        list.innerHTML += `
                        <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; gap:10px; align-items:start; ${n.read ? 'opacity:0.6' : ''}">
                            <div style="background:var(--accent); width:8px; height:8px; border-radius:50%; margin-top:6px; ${n.read ? 'display:none' : ''}"></div>
                            <div>
                                <div style="font-size:15px;">${n.text}</div>
                                <div style="font-size:12px; color:var(--text-sec);">${timeStr}</div>
                            </div>
                        </div>`;
                    });
                });
                activeListeners.push(unsub);
            },

            // COMMENT UPDATE LOGIC
            submitComment: async function(postId, inputId) {
                const input = document.getElementById(inputId);
                const text = input.value.trim();
                if(!text) return;
                
                // Check if replying
                const replyState = replyingState[postId];
                let parentId = null;
                let replyToName = null;
                let replyToId = null;

                if (replyState && replyState.id) {
                    parentId = replyState.id; 
                    replyToName = replyState.name;
                    replyToId = replyState.authorId;
                }

                const comment = { 
                    id: Date.now(), 
                    authorId: currentUserData.id,
                    authorName: currentUserData.name, 
                    authorUsername: currentUserData.username,
                    text: text, 
                    timestamp: Date.now(),
                    parentId: parentId, 
                    replyToName: replyToName 
                }; 

                await updateDoc(doc(db, "posts", postId), {
                    comments: arrayUnion(comment)
                });
                
                input.value = "";
                delete replyingState[postId];
                
                const placeholder = document.getElementById(`placeholder-${inputId}`);
                if(placeholder) placeholder.remove();

                const snap = await getDoc(doc(db, "posts", postId));
                if(snap.exists()) {
                    const data = snap.data();
                    
                    // Notify Post Owner
                    if(data.authorId !== currentUserData.id && !data.isChannel) {
                        this.addNotification(data.authorId, 'comment', `${currentUserData.name} commented on your post.`);
                    }
                    
                    // Notify Reply Author
                    if(replyToId && replyToId !== currentUserData.id && replyToId !== data.authorId) {
                         this.addNotification(replyToId, 'reply', `${currentUserData.name} replied to your comment.`);
                    }
                }
            },

            deleteComment: async function(postId, commentObj) {
                if(!confirm("Delete comment?")) return;
                await updateDoc(doc(db, "posts", postId), {
                    comments: arrayRemove(commentObj)
                });
                this.showToast("Comment deleted");
                document.getElementById('context-menu').style.display = 'none';
            },

            editComment: async function(postId, commentObj) {
                document.getElementById('context-menu').style.display = 'none';
                const newText = prompt("Edit comment:", commentObj.text);
                if(newText && newText !== commentObj.text) {
                    await updateDoc(doc(db, "posts", postId), {
                        comments: arrayRemove(commentObj)
                    });
                    const newComment = { ...commentObj, text: newText };
                    await updateDoc(doc(db, "posts", postId), {
                        comments: arrayUnion(newComment)
                    });
                }
            },

            reportComment: function() {
                this.showToast("Comment reported for review.");
                document.getElementById('context-menu').style.display = 'none';
            },

            replyToComment: function(commentId, authorName, authorId, inputId) {
                const input = document.getElementById(inputId);
                const postId = inputId.replace('input-', '');
                replyingState[postId] = { id: commentId, name: authorName, authorId: authorId }; 

                let placeholder = document.getElementById(`placeholder-${inputId}`);
                if(!placeholder) {
                    placeholder = document.createElement('div');
                    placeholder.id = `placeholder-${inputId}`;
                    placeholder.style.fontSize = "12px";
                    placeholder.style.color = "var(--accent)";
                    placeholder.style.marginBottom = "5px";
                    placeholder.style.display = "flex";
                    placeholder.style.justifyContent = "space-between";
                    input.parentNode.insertBefore(placeholder, input);
                }
                placeholder.innerHTML = `<span>Replying to <span class="mention-name">${authorName}</span></span> <span style="cursor:pointer; color:var(--text-sec)" onclick="app.cancelReply('${postId}', '${inputId}')">‚úï</span>`;
                
                input.focus();
            },

            cancelReply: function(postId, inputId) {
                delete replyingState[postId];
                const placeholder = document.getElementById(`placeholder-${inputId}`);
                if(placeholder) placeholder.remove();
            },

            // LONG PRESS HANDLER
            handleLongPress: function(e, postId, commentObj) {
                // Prevent default context menu
                e.preventDefault();
                
                let pressTimer;
                const target = e.currentTarget; // The comment bubble
                
                const start = () => {
                    pressTimer = setTimeout(() => {
                        ctxPostId = postId;
                        ctxCommentObj = commentObj;
                        
                        const menu = document.getElementById('context-menu');
                        const rect = target.getBoundingClientRect();
                        
                        menu.style.top = (rect.bottom + window.scrollY) + 'px';
                        menu.style.left = (rect.left + window.scrollX) + 'px';
                        menu.style.display = 'flex';
                        
                        if (navigator.vibrate) navigator.vibrate(50);
                    }, 600);
                };
                
                const cancel = () => {
                    clearTimeout(pressTimer);
                };
                
                target.addEventListener('mousedown', start);
                target.addEventListener('touchstart', start);
                target.addEventListener('mouseup', cancel);
                target.addEventListener('mouseleave', cancel);
                target.addEventListener('touchend', cancel);
                
                // One-time listeners for this specific event
                setTimeout(() => {
                    target.removeEventListener('mousedown', start);
                    target.removeEventListener('touchstart', start);
                    target.removeEventListener('mouseup', cancel);
                    target.removeEventListener('mouseleave', cancel);
                    target.removeEventListener('touchend', cancel);
                }, 1000);
            },

            ctxAction: function(action) {
                document.getElementById('context-menu').style.display = 'none';
                if(!ctxCommentObj) return;
                
                if(action === 'delete') this.deleteComment(ctxPostId, ctxCommentObj);
                else if(action === 'edit') this.editComment(ctxPostId, ctxCommentObj);
                else if(action === 'report') this.reportComment();
            },

            toggleFollow: async function(targetId, isChannel, btnElement, feedContext) {
                if(targetId === currentUserData.id && !isChannel) return;
                
                const originalText = btnElement.innerText;
                const isFollowing = btnElement.classList.contains('following');

                if(isFollowing) {
                    btnElement.innerText = "Follow";
                    btnElement.classList.remove('following');
                } else {
                    btnElement.innerText = "Following";
                    btnElement.classList.add('following');
                    if(feedContext) btnElement.style.display = 'none';
                }

                try {
                    if(isChannel) {
                        const chanRef = doc(db, "channels", targetId);
                        const snap = await getDoc(chanRef);
                        if(snap.exists()) {
                            const followers = snap.data().followers || [];
                            if(followers.includes(currentUserData.id)) {
                                await updateDoc(chanRef, { followers: arrayRemove(currentUserData.id) });
                                // Also remove from user's followingChannels
                                await updateDoc(doc(db, "users", currentUserData.id), { followingChannels: arrayRemove(targetId) });
                            } else {
                                await updateDoc(chanRef, { followers: arrayUnion(currentUserData.id) });
                                await updateDoc(doc(db, "users", currentUserData.id), { followingChannels: arrayUnion(targetId) });
                            }
                        }
                    } else {
                        const myRef = doc(db, "users", currentUserData.id);
                        const targetRef = doc(db, "users", targetId);
                        
                        const mySnap = await getDoc(myRef);
                        const myFollowing = mySnap.data().following || [];
                        
                        if(myFollowing.includes(targetId)) {
                            await updateDoc(myRef, { following: arrayRemove(targetId) });
                            await updateDoc(targetRef, { followers: arrayRemove(currentUserData.id) });
                        } else {
                            await updateDoc(myRef, { following: arrayUnion(targetId) });
                            await updateDoc(targetRef, { followers: arrayUnion(currentUserData.id) });
                        }
                    }
                } catch(e) {
                    btnElement.innerText = originalText;
                    if(isFollowing) btnElement.classList.add('following');
                    else btnElement.classList.remove('following');
                }
            },

            openFollowersModal: async function(uid, isChannel = false) {
                document.getElementById('modal-users-title').innerText = isChannel ? "Channel Followers" : "Followers";
                const list = document.getElementById('modal-users-content');
                list.innerHTML = "Loading...";
                document.getElementById('modal-users-list').classList.add('open');
                
                const uRef = isChannel ? doc(db, "channels", uid) : doc(db, "users", uid);
                const uSnap = await getDoc(uRef);
                if(uSnap.exists()){
                    const followers = uSnap.data().followers || [];
                    if(followers.length === 0) list.innerHTML = "No followers yet";
                    else {
                        list.innerHTML = '';
                        for(let fid of followers) {
                            const fSnap = await getDoc(doc(db, "users", fid));
                            if(fSnap.exists()){
                                const f = fSnap.data();
                                list.innerHTML += `<div class="list-user-item" onclick="app.openProfile('${f.id}'); document.getElementById('modal-users-list').classList.remove('open')"><img src="${f.avatar}" style="width:40px;height:40px;border-radius:50%;"><div style="font-weight:bold">${f.name}</div></div>`;
                            }
                        }
                    }
                }
            },
            openFollowingModal: async function(uid) {
                document.getElementById('modal-users-title').innerText = "Following";
                const list = document.getElementById('modal-users-content');
                list.innerHTML = "Loading...";
                document.getElementById('modal-users-list').classList.add('open');

                const uRef = doc(db, "users", uid);
                const uSnap = await getDoc(uRef);
                if(uSnap.exists()){
                    const following = uSnap.data().following || [];
                    if(following.length === 0) list.innerHTML = "Not following anyone";
                    else {
                        list.innerHTML = '';
                        for(let fid of following) {
                            const fSnap = await getDoc(doc(db, "users", fid));
                            if(fSnap.exists()){
                                const f = fSnap.data();
                                list.innerHTML += `<div class="list-user-item" onclick="app.openProfile('${f.id}'); document.getElementById('modal-users-list').classList.remove('open')"><img src="${f.avatar}" style="width:40px;height:40px;border-radius:50%;"><div style="font-weight:bold">${f.name}</div></div>`;
                            }
                        }
                    }
                }
            },

            loadChatList: function() {
                const list = document.getElementById('chat-list');
                list.innerHTML = "";
                const myFollowing = currentUserData.following || [];
                if(myFollowing.length === 0) {
                    list.innerHTML = "<div style='padding:20px;text-align:center'>You don't follow anyone yet.</div>";
                    return;
                }
                
                myFollowing.forEach(fid => {
                    getDoc(doc(db, "users", fid)).then(snap => {
                        if(snap.exists()) {
                            const u = snap.data();
                            const item = document.createElement('div');
                            item.className = "chat-list-item";
                            item.innerHTML = `<img src="${u.avatar}" class="pc-avatar"><div style="flex:1"><div style="font-weight:bold">${u.name}</div><div style="color:#777;font-size:13px">@${u.username}</div></div>`;
                            item.onclick = () => app.startChat(fid, u.name, u.avatar);
                            list.appendChild(item);
                        }
                    });
                });
            },
            
            startChat: function(targetId, name, avatar) {
                currentChatUserId = targetId;
                currentChatId = [currentUserData.id, targetId].sort().join('_');
                
                document.getElementById('chat-header-name').innerText = name;
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById('view-chat-detail').classList.add('active');
                
                const msgContainer = document.getElementById('chat-messages');
                const q = query(collection(db, "chats", currentChatId, "messages"), orderBy("timestamp", "asc"));
                const unsub = onSnapshot(q, (snap) => {
                    msgContainer.innerHTML = "";
                    snap.forEach(d => {
                        const m = d.data();
                        const isMe = m.senderId === currentUserData.id;
                        const bubble = document.createElement('div');
                        bubble.className = `msg-bubble ${isMe ? 'msg-sent' : 'msg-received'}`;
                        bubble.innerText = m.text;
                        msgContainer.appendChild(bubble);
                    });
                    msgContainer.scrollTop = msgContainer.scrollHeight;
                });
                activeListeners.push(unsub);
            },
            
            sendMessage: async function() {
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                if(!text) return;
                if(!currentChatId) return this.showToast("Select a user to chat", 'error');

                try {
                    await addDoc(collection(db, "chats", currentChatId, "messages"), {
                        senderId: currentUserData.id,
                        text: text,
                        timestamp: Date.now()
                    });
                    input.value = "";
                    const msgContainer = document.getElementById('chat-messages');
                    msgContainer.scrollTop = msgContainer.scrollHeight;
                } catch (e) {
                    console.error(e);
                    this.showToast("Message failed", 'error');
                }
            },

            timeAgo: function(timestamp) {
                const seconds = Math.floor((new Date() - timestamp) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + "y";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + "mo";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + "d";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + "h";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + "m";
                return "Just now";
            },

            listenToFeed: function(viewType) {
                const containerId = viewType === 'video' ? 'video-feed' : 'home-feed';
                const container = document.getElementById(containerId);
                
                let q = query(collection(db, "posts"), orderBy("timestamp", "desc"));

                const unsub = onSnapshot(q, (snapshot) => {
                    container.innerHTML = '';
                    let posts = [];
                    snapshot.forEach(doc => posts.push({id: doc.id, ...doc.data()}));
                    
                    if(viewType === 'video') posts = posts.filter(p => p.type === 'video');
                    if(posts.length === 0) container.innerHTML = "<div style='padding:40px;text-align:center;color:#777'>No posts yet</div>";

                    // Shuffle slightly for "Random" effect but keep popular on top
                    posts.sort((a,b) => {
                        const scoreA = (a.likes || 0) + (a.views || 0);
                        const scoreB = (b.likes || 0) + (b.views || 0);
                        return scoreB - scoreA;
                    });

                    posts.forEach(post => { 
                        container.innerHTML += this.buildPostHTML(post, viewType); 
                    });
                });
                
                activeListeners.push(unsub);
            },

            listenToChannels: async function() {
                const list = document.getElementById('all-channels-list');
                const title = document.getElementById('channel-list-title');
                
                const myFollowed = currentUserData.followingChannels || [];
                
                // If user follows channels, show followed. Else show trending (last 24h).
                if(myFollowed.length > 0) {
                    title.innerText = "Followed Channels";
                    list.innerHTML = '';
                    myFollowed.forEach(cid => {
                        getDoc(doc(db, "channels", cid)).then(snap => {
                            if(snap.exists()) {
                                const c = snap.data();
                                list.innerHTML += `<div class="search-result-item" onclick="app.openChannel('${cid}')"><img src="${c.cover || c.avatar}" class="pc-avatar" style="border-radius:8px;"><div><div style="font-weight:bold;">${c.name}</div><div style="color:var(--text-sec); font-size:13px;">${c.category || 'Channel'}</div></div></div>`;
                            }
                        });
                    });
                } else {
                    title.innerText = "Trending Channels (24h)";
                    // Simple trending logic: Get all channels, filter by recent posts (mocked here by just showing all for now as we don't have analytics)
                    // For this demo, we'll just show all channels but sorted randomly to simulate "Discovery"
                    const q = query(collection(db, "channels"), orderBy("timestamp", "desc"));
                    const snap = await getDocs(q);
                    list.innerHTML = '';
                    snap.forEach(doc => {
                        const c = doc.data();
                        list.innerHTML += `<div class="search-result-item" onclick="app.openChannel('${doc.id}')"><img src="${c.cover || c.avatar}" class="pc-avatar" style="border-radius:8px;"><div><div style="font-weight:bold;">${c.name}</div><div style="color:var(--text-sec); font-size:13px;">${c.category || 'Channel'}</div></div></div>`;
                    });
                }
            },

            // NEW: RENDER COMMENTS WITH NESTING
            renderComments: function(comments, postId) {
                if(!comments || comments.length === 0) return '';

                const commentMap = {};
                const topLevel = [];

                comments.forEach(c => {
                    commentMap[c.id] = {...c, replies: []};
                });

                comments.forEach(c => {
                    if(c.parentId && commentMap[c.parentId]) {
                        commentMap[c.parentId].replies.push(commentMap[c.id]);
                    } else {
                        topLevel.push(commentMap[c.id]);
                    }
                });

                const buildHTML = (commentList, isReply = false) => {
                    if(!commentList || commentList.length === 0) return '';
                    
                    return commentList.map(c => {
                        const commentAvatar = c.authorId ? `https://picsum.photos/seed/${c.authorId}/50/50` : `https://picsum.photos/seed/livo/50/50`;
                        const isMine = c.authorId === currentUserData.id;
                        
                        // Handle Mention Name in Reply
                        let displayText = c.text;
                        let mentionPrefix = '';
                        
                        if(c.replyToName) {
                            mentionPrefix = `<span class="mention-name" onclick="event.stopPropagation(); app.openProfile('${c.replyToId || ''}')">${c.replyToName}</span> `;
                        }

                        // Highlight Hashtags and Mentions inside text
                        displayText = this.formatText(displayText);

                        return `
                        <div class="comment-item" style="${isReply ? '' : 'width:100%'}">
                            <img src="${commentAvatar}" class="comment-avatar" onclick="app.openProfile('${c.authorId}')">
                            <div class="comment-content-wrapper">
                                <div class="comment-bubble" oncontextmenu="app.handleLongPress(event, '${postId}', ${JSON.stringify(c).replace(/"/g, '&quot;')})">
                                    <div class="comment-header">
                                        <span class="comment-author" onclick="event.stopPropagation(); app.openProfile('${c.authorId}')">${c.authorName}</span>
                                        <span style="font-size:11px; color:var(--text-sec)">${this.timeAgo(c.timestamp)}</span>
                                    </div>
                                    <div style="color:var(--text-main); font-size:14px;">
                                        ${mentionPrefix}<span>${displayText}</span>
                                    </div>
                                </div>
                                <div class="comment-actions-row">
                                    <span class="comment-action-btn" onclick="app.replyToComment('${c.id}', '${c.authorName.replace(/'/g, "\\'")}', '${c.authorId}', 'input-${postId}')">Reply</span>
                                </div>
                                ${c.replies && c.replies.length > 0 ? `<div class="reply-thread">${buildHTML(c.replies, true)}</div>` : ''}
                            </div>
                        </div>`;
                    }).join('');
                };

                return buildHTML(topLevel);
            },

            // Format Text (Hashtags and Mentions)
            formatText: function(text) {
                if(!text) return '';
                // Replace #hashtags
                let formatted = text.replace(/#(\w+)/g, '<span class="highlight-text">#$1</span>');
                // Replace @mentions
                formatted = formatted.replace(/@(\w+)/g, '<span class="highlight-text">@$1</span>');
                return formatted;
            },

            toggleTextExpansion: function(el, originalClass) {
                // Check if it is currently expanded (class removed)
                if (!el.classList.contains(originalClass)) {
                    el.classList.add(originalClass);
                    // Show see more again
                    const seeMore = el.nextElementSibling;
                    if(seeMore && seeMore.classList.contains('see-more')) {
                        seeMore.style.display = 'block';
                    }
                } else {
                    // Do nothing, let the "See more" button handle expansion
                }
            },

            buildPostHTML: function(post, viewType) {
                const isChannel = post.isChannel;
                const isMyPost = post.authorId === currentUserData.id || (isChannel && post.channelId === this.state.viewingChannelId); 
                
                let avatarUrl = post.postAvatarUrl || `https://picsum.photos/seed/${post.authorId}/200/200`;
                
                const nameClick = isChannel ? `onclick="event.stopPropagation(); app.openChannel('${post.channelId}')"` : `onclick="event.stopPropagation(); app.openProfile('${post.authorId}')"`;
                const avatarClick = nameClick;

                let mediaHTML = '';
                if(post.media) {
                    const mediaClass = post.type === 'video' ? 'vid-mode' : 'img-mode';
                    if(post.type === 'video') {
                        mediaHTML = `<div class="pc-media-wrapper ${mediaClass}" onclick="event.stopPropagation(); app.viewImage('${post.media}')"><video controls playsinline src="${post.media}"></video></div>`;
                    } else {
                        mediaHTML = `<div class="pc-media-wrapper ${mediaClass}" onclick="event.stopPropagation(); app.viewImage('${post.media}')"><img src="${post.media}" loading="lazy"></div>`;
                    }
                }

                // Follow Button Logic
                let followBtnHTML = '';
                if(!isMyPost && isChannel) {
                     const isFollowing = currentUserData.followingChannels && currentUserData.followingChannels.includes(post.channelId);
                     if(!isFollowing) {
                        followBtnHTML = `<button class="follow-btn-small" onclick="event.stopPropagation(); app.toggleFollow('${post.channelId}', true, this, true)">Follow</button>`;
                     }
                }
                else if (!isMyPost && !isChannel && post.authorId !== currentUserData.id) { 
                    const isFollowing = currentUserData.following && currentUserData.following.includes(post.authorId);
                    if(!isFollowing) {
                        followBtnHTML = `<button class="follow-btn-small" onclick="event.stopPropagation(); app.toggleFollow('${post.authorId}', false, this, true)">Follow</button>`;
                    }
                }

                let optionsMenu = '';
                if(isMyPost) {
                    optionsMenu = `
                        <div class="post-options-btn" onclick="event.stopPropagation(); this.nextElementSibling.classList.toggle('show');">‚Ä¢‚Ä¢‚Ä¢</div>
                        <div class="post-menu" onclick="event.stopPropagation(); this.classList.remove('show');">
                            <div class="pm-item" onclick="app.editPost('${post.id}')">Edit</div>
                            <div class="pm-item delete" onclick="app.deletePost('${post.id}')">Delete</div>
                            <div class="pm-item" onclick="app.toggleSave('${post.id}')">${savedPosts.includes(post.id) ? 'Remove Bookmark' : 'Bookmark'}</div>
                        </div>
                    `;
                } else {
                    optionsMenu = `
                        <div class="post-options-btn" onclick="event.stopPropagation(); this.nextElementSibling.classList.toggle('show');">‚Ä¢‚Ä¢‚Ä¢</div>
                        <div class="post-menu" onclick="event.stopPropagation(); this.classList.remove('show');">
                            <div class="pm-item" onclick="app.toggleSave('${post.id}')">${savedPosts.includes(post.id) ? 'Remove Bookmark' : 'Bookmark'}</div>
                        </div>
                    `;
                }

                // TRUNCATION LOGIC with toggle capability
                const isLongText = post.content && post.content.length > 100;
                const limitClass = post.media ? 'post-text-clamped-2' : 'post-text-clamped-7';
                const activeClass = isLongText ? (post.media ? 'limit-active-2' : 'limit-active-7') : '';
                
                // Highlight hashtags/mentions in post content
                const formattedContent = this.formatText(post.content);

                const seeMoreBtn = isLongText ? `<div class="see-more" onclick="event.stopPropagation(); this.previousElementSibling.classList.remove('${limitClass}'); this.style.display='none'">See more</div>` : '';

                // Render Comments
                const commentsHTML = this.renderComments(post.comments, post.id);

                const isLiked = post.likedBy && post.likedBy.includes(currentUserData.id);
                const likeClass = isLiked ? "liked" : "";
                const timeString = this.timeAgo(post.timestamp);
                const moodAttr = post.mood ? `data-mood="${post.mood}"` : '';
                
                // Highlight Popular Posts
                const highlightClass = ((post.likes || 0) + (post.views || 0)) > 5 ? 'highlight' : '';

                return `
                <div class="post-card ${highlightClass}" ${moodAttr} onclick="document.querySelectorAll('.post-menu').forEach(m=>m.classList.remove('show'))">
                    <div class="pc-header">
                        <div class="pc-user-info">
                            <img src="${avatarUrl}" class="pc-avatar" ${avatarClick}>
                            <div class="pc-meta">
                                <div class="pc-top-line">
                                    <div class="pc-name" ${nameClick}>${post.authorName}</div>
                                    ${followBtnHTML}
                                </div>
                                <div class="pc-time">${timeString}</div>
                            </div>
                        </div>
                        ${optionsMenu}
                    </div>
                    
                    <div class="pc-text ${limitClass} ${activeClass}" onclick="app.toggleTextExpansion(this, '${limitClass}')">${formattedContent}</div>
                    ${seeMoreBtn}
                    ${mediaHTML}
                    
                    <div class="pc-actions">
                        <div class="action-item like ${likeClass}" onclick="app.toggleLike('${post.id}', this)">
                            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                            <span>${post.likes || 0}</span>
                        </div>
                        <div class="action-item comment" onclick="document.getElementById('comments-${post.id}').classList.toggle('open')">
                            <svg viewBox="0 0 24 24"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                            <span>${post.comments ? post.comments.length : 0}</span>
                        </div>
                        <div class="action-item">
                            <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
                        </div>
                    </div>

                    <div id="comments-${post.id}" class="comments-section">
                        ${commentsHTML}
                        <div class="comment-input-wrapper">
                            <input type="text" class="comment-input" id="input-${post.id}" placeholder="Write a comment..." onkeydown="if(event.key==='Enter') app.submitComment('${post.id}', 'input-${post.id}')">
                            <button class="comment-btn" onclick="app.submitComment('${post.id}', 'input-${post.id}')">Send</button>
                        </div>
                    </div>
                </div>
                `;
            },

            viewImage: function(url) {
                document.getElementById('viewer-img').src = url;
                document.getElementById('img-viewer').style.display = 'flex';
            },

            openProfile: async function(uid) {
                this.state.viewingProfileId = uid; 
                this.state.viewingChannelId = null;
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById('view-profile').classList.add('active');
                
                let user = null;
                if(uid === currentUserData.id) {
                    user = currentUserData;
                } else {
                    const snap = await getDoc(doc(db, "users", uid));
                    if(snap.exists()) user = {id: snap.id, ...snap.data()};
                }

                if(!user) return;

                const isMe = user.id === currentUserData.id;
                const coverSrc = user.cover || user.avatar; 
                const followCount = user.followers ? user.followers.length : 0;
                const followingCount = user.following ? user.following.length : 0;
                const isFollowing = currentUserData.following && currentUserData.following.includes(user.id);
                
                let actionBtn = '';
                let extraActions = '';
                
                if(!isMe) {
                    const btnText = isFollowing ? "Following" : "Follow";
                    const btnStyle = isFollowing ? "background: white; color: black;" : "";
                    actionBtn = `<button class="edit-btn" style="${btnStyle}" onclick="app.toggleFollow('${user.id}', false, this)">${btnText}</button>`;
                    
                    extraActions = `
                    <button class="btn-secondary" onclick="app.startChat('${user.id}', '${user.name}', '${user.avatar}')">Message</button>
                    <button class="more-btn" onclick="event.stopPropagation(); document.getElementById('profile-menu').classList.toggle('show')">‚Ä¢‚Ä¢‚Ä¢</button>
                    <div id="profile-menu" class="profile-menu" onclick="event.stopPropagation(); this.classList.remove('show')">
                         <div class="pm-item" onclick="navigator.clipboard.writeText('@${user.username}'); app.showToast('Copied')">Copy Link</div>
                         <div class="pm-item report" onclick="alert('Reported User @${user.username}')">Report</div>
                    </div>
                    `;
                } else {
                    actionBtn = `<button class="edit-btn profile-edit-btn" onclick="app.openEditProfileModal()">Edit Profile</button>`;
                }

                const headerHTML = `
                    <div class="profile-header">
                        <div class="cover-wrapper" onclick="app.viewImage('${coverSrc}')">
                            <img src="${coverSrc}" class="cover-pic">
                            ${isMe ? `<input type="file" id="cover-upload" accept="image/*" onchange="app.updateProfileImage('cover', this)" style="display:none"><div class="cover-upload-trigger" onclick="event.stopPropagation(); document.getElementById('cover-upload').click()">üì∑</div>` : ''}
                        </div>
                        <div class="profile-pic-wrapper">
                            <img src="${user.avatar}" class="profile-pic" onclick="app.viewImage('${user.avatar}')">
                            ${isMe ? `<input type="file" id="avatar-upload" accept="image/*" onchange="app.updateProfileImage('avatar', this)" style="display:none"><div class="avatar-upload-trigger" onclick="event.stopPropagation(); document.getElementById('avatar-upload').click()">üì∑</div>` : ''}
                        </div>
                        <div class="ph-details">
                            <div class="ph-top-row">
                                <div>
                                    <div class="ph-name">${user.name}</div>
                                    <div class="ph-username">@${user.username}</div>
                                </div>
                                <div style="display:flex; gap:10px; align-items:center;">
                                    ${actionBtn}
                                    ${extraActions}
                                </div>
                            </div>
                            <div class="ph-meta-stats">
                                <div onclick="app.openFollowersModal('${user.id}')"><span class="ph-stat-count">${followCount}</span> <span class="ph-stat-label">followers</span></div>
                                <div onclick="app.openFollowingModal('${user.id}')"><span class="ph-stat-count">${followingCount}</span> <span class="ph-stat-label">following</span></div>
                            </div>
                            <div class="ph-bio">${user.bio}</div>
                            <div class="ph-meta">
                                <span>üìç ${user.location || ''}</span>
                                ${user.website ? `<span>üîó <a href="${user.website}" target="_blank" style="color:var(--accent);text-decoration:none;">${user.website}</a></span>` : ''}
                            </div>
                        </div>
                    </div>`;
                document.getElementById('profile-header-content').innerHTML = headerHTML;
                
                const postBox = document.getElementById('profile-post-box');
                document.getElementById('profile-avatar').src = user.avatar;
                if(isMe) { postBox.style.display = 'flex'; } else { postBox.style.display = 'none'; }

                this.cleanupListeners();
                const feedContainer = document.getElementById('profile-feed');
                const q = query(collection(db, "posts"), where("authorId", "==", uid), where("isChannel", "==", false), orderBy("timestamp", "desc"));
                const unsub = onSnapshot(q, (snapshot) => {
                    feedContainer.innerHTML = '';
                    let posts = [];
                    snapshot.forEach(doc => posts.push({id: doc.id, ...doc.data()}));
                    const feedHTML = posts.map(p => this.buildPostHTML(p)).join('');
                    feedContainer.innerHTML = feedHTML || "<div style='padding:40px;text-align:center;color:#777'>No posts yet</div>";
                });
                activeListeners.push(unsub);
            },

            openChannel: async function(chanId) {
                this.state.viewingChannelId = chanId; 
                this.state.viewingProfileId = null;
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById('view-channel').classList.add('active');
                
                const snap = await getDoc(doc(db, "channels", chanId));
                if(!snap.exists()) return this.showToast("Channel not found", 'error');
                const chan = {id: snap.id, ...snap.data()};

                const isOwner = chan.ownerId === currentUserData.id;
                const isFollowing = currentUserData.followingChannels && currentUserData.followingChannels.includes(chanId);

                const coverSrc = chan.cover || chan.avatar;

                let extraActions = '';
                let editBtn = '';

                if(isOwner) {
                    editBtn = `<button class="edit-btn profile-edit-btn" onclick="app.openEditChannelModal('${chanId}')">Edit Channel</button>`;
                } else {
                    extraActions = `
                    <button class="btn-secondary" onclick="app.startChat('${chan.ownerId}', '${chan.name}', '${chan.avatar}')">Message</button>
                    `;
                }

                const headerHTML = `
                    <div class="profile-header">
                        <div class="cover-wrapper">
                             <img src="${coverSrc}" class="cover-pic">
                             ${isOwner ? `<input type="file" id="channel-cover-upload" accept="image/*" onchange="app.updateChannelImage('cover', this)" style="display:none"><div class="cover-upload-trigger" onclick="event.stopPropagation(); document.getElementById('channel-cover-upload').click()">üì∑</div>` : ''}
                        </div>
                        <div class="profile-pic-wrapper">
                             <img src="${chan.avatar}" class="profile-pic">
                             ${isOwner ? `<input type="file" id="channel-avatar-upload" accept="image/*" onchange="app.updateChannelImage('avatar', this)" style="display:none"><div class="avatar-upload-trigger" onclick="event.stopPropagation(); document.getElementById('channel-avatar-upload').click()">üì∑</div>` : ''}
                        </div>
                        <div class="ph-details">
                            <div class="ph-top-row">
                                <div>
                                    <div class="ph-name">${chan.name}</div>
                                    <div class="ph-category">${chan.category}</div>
                                    <div class="ph-username" style="font-size:13px; margin-top:2px;">@${chan.username || ''}</div>
                                </div>
                                <div style="display:flex; gap:10px; align-items:center;">
                                    ${isOwner ? editBtn : `<button class="edit-btn" style="${isFollowing ? 'background: white; color: black;' : ''}" onclick="app.toggleFollow('${chan.id}', true, this)">${isFollowing ? 'Following' : 'Follow'}</button>`}
                                    ${extraActions}
                                </div>
                            </div>
                            <!-- Channel Stats -->
                            <div class="ph-meta-stats">
                                <div onclick="app.openFollowersModal('${chan.id}', true)"><span class="ph-stat-count">${chan.followers ? chan.followers.length : 0}</span> <span class="ph-stat-label">followers</span></div>
                                <div><span class="ph-stat-count">0</span> <span class="ph-stat-label">following</span></div>
                            </div>
                            <div class="ph-bio">${chan.bio}</div>
                        </div>
                    </div>`;
                document.getElementById('channel-header-content').innerHTML = headerHTML;
                
                const postBox = document.getElementById('channel-post-box');
                document.getElementById('channel-avatar').src = chan.avatar;
                if(isOwner) { postBox.style.display = 'flex'; } else { postBox.style.display = 'none'; }
                
                this.cleanupListeners();
                const feedContainer = document.getElementById('channel-feed');
                const q = query(collection(db, "posts"), where("channelId", "==", chanId), orderBy("timestamp", "desc"));
                const unsub = onSnapshot(q, (snapshot) => {
                    feedContainer.innerHTML = '';
                    let posts = [];
                    snapshot.forEach(doc => posts.push({id: doc.id, ...doc.data()}));
                    const feedHTML = posts.map(p => this.buildPostHTML(p)).join('');
                    feedContainer.innerHTML = feedHTML || "<div style='padding:40px;text-align:center;color:#777'>No posts in this channel</div>";
                });
                activeListeners.push(unsub);
            },

            openEditChannelModal: async function(chanId) {
                const snap = await getDoc(doc(db, "channels", chanId));
                if(!snap.exists()) return;
                const c = snap.data();
                
                document.getElementById('edit-chan-id').value = chanId;
                document.getElementById('edit-chan-name').value = c.name;
                document.getElementById('edit-chan-username').value = c.username || '';
                document.getElementById('edit-chan-category').value = c.category;
                document.getElementById('edit-chan-bio').value = c.bio;
                
                document.getElementById('modal-edit-channel').classList.add('open');
            },

            submitEditChannel: async function() {
                const id = document.getElementById('edit-chan-id').value;
                const name = document.getElementById('edit-chan-name').value;
                const username = document.getElementById('edit-chan-username').value;
                const category = document.getElementById('edit-chan-category').value;
                const bio = document.getElementById('edit-chan-bio').value;

                if(!name) return this.showToast("Name required", 'error');

                try {
                    await updateDoc(doc(db, "channels", id), {
                        name, username, category, bio
                    });
                    document.getElementById('modal-edit-channel').classList.remove('open');
                    this.openChannel(id);
                    this.showToast("Channel updated");
                } catch(e) {
                    this.showToast("Update failed", 'error');
                }
            },

            updateChannelImage: async function(type, input) {
                const file = input.files[0];
                if(!file) return;
                const chanId = this.state.viewingChannelId;
                if(!chanId) return;

                try {
                    this.showToast("Uploading image...");
                    const storageRef = ref(storage, `channels/${chanId}/${type}_${Date.now()}`);
                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);

                    const chanRef = doc(db, "channels", chanId);
                    const updateData = {};
                    if(type === 'avatar') updateData.avatar = url;
                    else if(type === 'cover') updateData.cover = url;
                    
                    await updateDoc(chanRef, updateData);
                    
                    this.openChannel(chanId); 
                    this.showToast("Image updated");
                } catch(e) {
                    console.error(e);
                    this.showToast("Upload failed", 'error');
                }
            },

            openCreateChannel: function() { document.getElementById('modal-create-channel').classList.add('open'); },

            submitCreateChannel: async function() {
                const name = document.getElementById('new-chan-name').value;
                const username = document.getElementById('new-chan-username').value;
                const category = document.getElementById('new-chan-category').value;
                const bio = document.getElementById('new-chan-bio').value;
                if(!name) return this.showToast("Name required", 'error');
                const newChan = { 
                    ownerId: currentUserData.id, name: name, username: username ? username.toLowerCase() : name.toLowerCase().replace(/\s+/g, ''), category: category, bio: bio, 
                    avatar: `https://cdn-icons-png.flaticon.com/512/2991/2991100.png`, 
                    cover: `https://cdn-icons-png.flaticon.com/512/3277/3277304.png`, 
                    followers: [],
                    timestamp: Date.now()
                };
                await addDoc(collection(db, "channels"), newChan); 
                document.getElementById('modal-create-channel').classList.remove('open'); 
                this.showToast("Channel Created");
            },

            handleSearch: function(query) {
                if(query.length < 2) { if(this.state.currentView === 'search') this.navTo('home'); return; }
                this.state.currentView = 'search';
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById('view-search').classList.add('active');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                this.renderSearch(query);
            },

            switchSearchTab: function(tab) {
                this.state.searchTab = tab;
                document.querySelectorAll('.s-tab').forEach(el => el.classList.remove('active'));
                event.target.classList.add('active');
                const query = document.querySelector('.search-input').value;
                this.renderSearch(query);
            },

            renderSearch: async function(query) {
                const list = document.getElementById('search-results-list'); 
                list.innerHTML = "<div style='padding:20px; color:#777; text-align:center'>Searching...</div>";
                
                try {
                    let results = [];
                    const lowerQuery = query.toLowerCase();
                    
                    const qUser = query(collection(db, "users"), where("name", ">=", query), where("name", "<=", query + "\uf8ff"));
                    const snapUser = await getDocs(qUser);
                    snapUser.forEach(doc => {
                        const u = doc.data();
                        results.push({
                            type: 'user', id: doc.id, name: u.name, sub: '@'+u.username, img: u.avatar
                        });
                    });
                    
                    const qUserExact = query(collection(db, "users"), where("username", "==", lowerQuery));
                    const snapUserExact = await getDocs(qUserExact);
                    snapUserExact.forEach(doc => {
                        const u = doc.data();
                        if(!results.find(r => r.id === doc.id)) {
                             results.push({ type: 'user', id: doc.id, name: u.name, sub: '@'+u.username, img: u.avatar });
                        }
                    });

                    const qChan = query(collection(db, "channels"), where("name", ">=", query), where("name", "<=", query + "\uf8ff"));
                    const snapChan = await getDocs(qChan);
                    snapChan.forEach(doc => {
                        const c = doc.data();
                        results.push({ type: 'channel', id: doc.id, name: c.name, sub: c.category, img: c.avatar });
                    });
                    
                    list.innerHTML = '';
                    if(results.length === 0) list.innerHTML = "<div style='padding:20px; color:#777; text-align:center'>No results found</div>";
                    
                    results.forEach(r => {
                        const badge = r.type === 'channel' ? `` : ''; 
                        const clickFn = r.type === 'channel' ? `app.openChannel('${r.id}')` : `app.openProfile('${r.id}')`;
                        
                        list.innerHTML += `
                        <div class="search-result-item" onclick="${clickFn}">
                            <img src="${r.img}" class="pc-avatar" ${r.type==='channel' ? "style='border-radius:8px;'" : ""}>
                            <div>
                                <div style="font-weight:bold;">${r.name} ${badge}</div>
                                <div style="color:var(--text-sec); font-size:13px;">${r.sub}</div>
                            </div>
                        </div>`;
                    });
                } catch(e) {
                    list.innerHTML = "<div style='padding:20px; color:#777; text-align:center'>Search failed</div>";
                }
            },

            updateProfileImage: async function(type, input) {
                const file = input.files[0];
                if(!file) return;
                try {
                    this.showToast("Uploading image...");
                    const storageRef = ref(storage, `users/${currentUserData.id}/${type}_${Date.now()}`);
                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);

                    const userRef = doc(db, "users", currentUserData.id);
                    const updateData = {};
                    if(type === 'avatar') updateData.avatar = url;
                    else if(type === 'cover') updateData.cover = url;
                    
                    await updateDoc(userRef, updateData);
                    if(type === 'avatar') currentUserData.avatar = url;
                    else currentUserData.cover = url;
                    
                    this.openProfile(currentUserData.id); 
                    this.showToast("Image updated");
                } catch(e) {
                    console.error(e);
                    this.showToast("Upload failed", 'error');
                }
            }
        };

        window.onload = () => app.init();
        
        // Close dropdowns on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.menu-btn') && !e.target.closest('.dropdown-menu')) {
                document.getElementById('main-menu').classList.remove('show');
            }
            if (!e.target.closest('#context-menu')) {
                document.getElementById('context-menu').style.display = 'none';
            }
        });

        window.app = app;
    </script>
</body>
</html>
