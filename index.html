<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Livo (Fixed)</title>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #16181c;
            --text-main: #e7e9ea;
            --text-sec: #71767b;
            --accent: #1d9bf0;
            --border: #2f3336;
            --like: #f91880;
            --live: #f91880;
            --chat-bg-sent: #1d9bf0;
            --chat-bg-received: #3a3b3c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); overflow-x: hidden; padding-top: 100px; padding-bottom: 20px; }
        
        button { cursor: pointer; border: none; outline: none; background: transparent; color: inherit; }
        input[type="text"], input[type="password"], input[type="email"], textarea { width: 100%; background: black; border:1px solid var(--border); color: var(--text-main); padding: 12px; border-radius: 4px; font-size: 15px; }
        input[type="file"] { display: none; }

        /* AUTH SCREENS */
        .auth-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; padding: 20px; background: black; }
        .auth-box { width: 100%; max-width: 400px; }
        .auth-title { font-size: 30px; font-weight: 800; margin-bottom: 30px; color: white; text-align: center; }
        .auth-input { margin-bottom: 12px; border-radius: 4px; }
        .auth-btn { background: var(--accent); color: white; font-weight: bold; padding: 15px; border-radius: 30px; width: 100%; font-size: 16px; margin-top: 10px; }
        .toggle-auth { margin-top: 20px; color: var(--text-sec); font-size: 14px; text-align: center; }
        .toggle-auth a { color: var(--accent); cursor: pointer; }

        /* HEADER & TOP NAV */
        .sticky-header { position: fixed; top: 0; left: 0; width: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); z-index: 100; border-bottom: 1px solid var(--border); }
        .app-header { padding: 10px 15px; display: flex; align-items: center; gap: 15px; justify-content: space-between; }
        .logo { font-size: 24px; font-weight: 900; color: white; letter-spacing: -1px; cursor: pointer; }
        
        .search-container { flex: 1; margin: 0 10px; position: relative; }
        .search-input { background: #202327; border: none; padding: 10px 15px 10px 40px; border-radius: 20px; width: 100%; color: white; font-size: 14px; }
        .search-icon { position: absolute; left: 12px; top: 10px; color: var(--text-sec); }

        .top-nav { display: flex; justify-content: space-around; padding: 5px 0; border-bottom: 1px solid var(--border); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sec); padding: 8px; width: 20%; position: relative; cursor: pointer; }
        .nav-item svg { width: 26px; height: 26px; fill: currentColor; transition: fill 0.2s; }
        .nav-item.active { color: var(--text-main); }
        .nav-item.active::after { content: ''; position: absolute; bottom: 0; width: 50px; height: 4px; background: var(--accent); border-radius: 2px; }

        /* MENU DROPDOWN */
        .menu-btn { font-size: 20px; color: var(--text-main); }
        .dropdown-menu { position: absolute; top: 60px; right: 15px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; width: 200px; display: none; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 101; }
        .dropdown-menu.show { display: flex; }
        .menu-opt { padding: 12px 15px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 15px; }
        .menu-opt:last-child { border-bottom: none; }
        .menu-opt:hover { background: var(--border); }

        /* MAIN CONTENT */
        .container { max-width: 600px; margin: 0 auto; padding: 0 10px; }
        .view-section { display: none; animation: fadeIn 0.2s; }
        .view-section.active { display: block; }

        /* COMPOSER BOX */
        .cp-box { padding: 15px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
        .cp-top-row { display: flex; align-items: flex-start; gap: 10px; }
        .cp-avatar-sm { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); transition: opacity 0.2s; }
        .cp-avatar-sm:hover { opacity: 0.8; }
        
        .cp-input-container { flex: 1; }
        .cp-input { border: none; background: transparent; font-size: 18px; color: white; resize: none; outline: none; min-height: 50px; padding: 10px 0; width: 100%; }
        
        .cp-tools { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; padding-left: 50px; }
        
        /* ICON+TEXT STYLE (Photo, Video, Live) */
        .cp-icons-group { display: flex; gap: 20px; }
        .cp-tool-btn { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            color: var(--accent); font-size: 11px; font-weight: bold; cursor: pointer; transition: 0.2s; gap: 2px; 
            border: 1px solid transparent; border-radius: 4px; padding: 4px 8px;
        }
        .cp-tool-btn:hover { background: rgba(29, 155, 240, 0.1); }
        .cp-tool-btn i { font-size: 16px; font-style: normal; }
        .cp-tool-btn.live { color: var(--live); }
        
        .cp-btn { background: var(--accent); color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 14px; opacity: 0.5; pointer-events: none; transition: 0.2s; white-space: nowrap; }
        .cp-btn.ready { opacity: 1; pointer-events: auto; }
        .file-status { font-size: 12px; color: var(--text-main); margin-left: auto; display: none; } 

        /* POST CARD */
        .post-card { padding: 15px 10px; border-bottom: 1px solid var(--border); position: relative; }
        .post-card:hover { background-color: rgba(255,255,255,0.03); }
        
        .pc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .pc-user-info { display: flex; align-items: center; gap: 10px; }
        .pc-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 1px solid var(--border); flex-shrink: 0; }
        .pc-meta { display: flex; flex-direction: column; }
        
        .pc-top-line { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        
        .pc-name { font-weight: bold; color: var(--text-main); cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 15px; }
        .pc-name:hover { text-decoration: underline; }
        .pc-time { font-size: 13px; color: var(--text-sec); }

        .follow-btn-small {
            background: var(--card-bg); border: 1px solid var(--border); color: var(--text-main);
            padding: 4px 12px; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; transition: 0.2s;
            white-space: nowrap; margin-left: 10px;
        }
        .follow-btn-small:hover { background: #333; }

        .pc-text { font-size: 15px; line-height: 1.4; margin-bottom: 10px; margin-left: 0; white-space: pre-wrap; word-break: break-word; color: white; }

        /* MEDIA WRAPPERS */
        .pc-media-wrapper { 
            width: 100%; 
            background: #000; 
            border-radius: 8px; 
            overflow: hidden; 
            position: relative; 
            margin-bottom: 10px; 
            border: 1px solid #333;
        }
        .pc-media video { width: 100%; height: 100%; display: block; object-fit: cover; }
        .pc-media img { width: 100%; display: block; object-fit: cover; }
        .pc-media-wrapper.vid-mode { aspect-ratio: 16/9; } 
        .pc-media-wrapper.img-mode { width: 100% !important; max-width: 100% !important; border-radius: 8px; } 

        .comments-section { margin-top: 10px; border-top: 1px solid var(--border); display: none; padding-top: 10px; }
        .comments-section.open { display: block; }
        .comment-item { padding: 8px 0; display: flex; gap: 10px; font-size: 13px; }
        .comment-bubble { background: #16181c; padding: 8px 12px; border-radius: 12px; flex: 1; }
        .comment-author { font-weight: bold; font-size: 12px; color: var(--text-sec); margin-bottom: 2px; }
        .comment-input-wrapper { display: flex; gap: 8px; margin-top: 10px; align-items: center; }
        .comment-input { background: #000; border: 1px solid var(--border); border-radius: 20px; padding: 8px 12px; font-size: 13px; color: white; width: 100%; }
        .comment-btn { background: var(--accent); color: white; border: none; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }

        .pc-actions { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
        .action-item { display: flex; align-items: center; gap: 6px; color: var(--text-sec); font-size: 14px; cursor: pointer; transition: color 0.2s; padding: 8px; border-radius: 4px; }
        .action-item:hover { background: rgba(29, 155, 240, 0.1); }
        .action-item:hover.like { color: var(--like); background: rgba(249, 24, 128, 0.1); }
        .action-item:hover.comment { color: var(--accent); background: rgba(29, 155, 240, 0.1); }
        .action-item i { font-size: 18px; font-style: normal; }
        .action-item.liked { color: var(--like) !important; } 

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* PROFILE HEADER */
        .profile-header { padding: 0 0 20px 0; border-bottom: 1px solid var(--border); position: relative; }
        .cover-wrapper { position: relative; width: 100%; height: 150px; background: #333; cursor: pointer; }
        .cover-pic { width: 100%; height: 100%; object-fit: cover; }
        .cover-upload-trigger { position: absolute; bottom: 10px; right: 10px; width: 32px; height: 32px; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; cursor: pointer; transition: background 0.2s; }
        .profile-pic-wrapper { position: relative; display: inline-block; margin-top: -50px; margin-left: 15px; }
        .profile-pic { width: 120px; height: 120px; border-radius: 50%; border: 4px solid black; object-fit: cover; position: relative; z-index: 2; background: #333; cursor: pointer; }
        .avatar-upload-trigger { position: absolute; bottom: 5px; right: 5px; width: 32px; height: 32px; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; transition: background 0.2s; color: white; }
        .ph-details { padding: 10px 15px 0 15px; }
        .ph-top-row { display: flex; justify-content: space-between; align-items: flex-start; }
        .ph-name { font-size: 22px; font-weight: 800; color: white; display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        
        .ph-meta-stats { display: flex; gap: 20px; margin-bottom: 12px; font-size: 14px; cursor: pointer; }
        .ph-stat-count { font-weight: bold; color: var(--text-main); }
        .ph-stat-label { color: var(--text-sec); }
        
        .ph-bio { color: var(--text-main); margin-bottom: 12px; font-size: 15px; line-height: 1.4; }
        .ph-meta { font-size: 14px; color: var(--text-sec); margin-bottom: 15px; display: flex; gap: 15px; }
        
        .profile-action-row { display: flex; gap: 10px; }
        .edit-btn { border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; font-weight: bold; font-size: 14px; min-width: 100px; text-align: center; transition: 0.2s; }
        .edit-btn:hover { background: white; color: black; border-color: white; }
        
        .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-main); padding: 8px 16px; border-radius: 6px; font-weight: bold; font-size: 14px; cursor: pointer; }
        .btn-secondary:hover { background: #333; }

        .more-btn { background: transparent; color: var(--text-sec); font-size: 20px; cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; }
        .more-btn:hover { background: #333; color: white; }

        .badge-channel { background: var(--accent); color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: normal; text-transform: uppercase; }
        
        /* PROFILE MENU */
        .profile-menu {
            position: absolute; top: 10px; right: 0; background: var(--card-bg);
            border: 1px solid var(--border); border-radius: 8px;
            display: none; flex-direction: column;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 20;
            min-width: 150px;
        }
        .profile-menu.show { display: flex; }
        .pm-item { padding: 10px 15px; cursor: pointer; font-size: 14px; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .pm-item:hover { background: var(--border); }
        .pm-item.report { color: #f4212e; }

        /* SEARCH */
        .search-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 15px; }
        .s-tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; border-bottom: 2px solid transparent; color: var(--text-sec); font-weight: 500; transition: 0.2s; }
        .s-tab.active { border-bottom-color: var(--accent); color: var(--accent); font-weight: bold; }
        .search-result-item { padding: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .search-result-item:hover { background: rgba(255,255,255,0.03); }

        /* CHAT UI */
        #chat-input-row { display: flex; gap: 10px; padding: 10px; border-top: 1px solid var(--border); align-items: center; background: black; position: fixed; bottom: 0; left: 0; width: 100%; max-width: 600px; z-index: 90; }
        .chat-msg-container { padding: 15px; padding-bottom: 80px; overflow-y: auto; height: calc(100vh - 150px); }
        
        .msg-bubble { max-width: 70%; padding: 10px 14px; border-radius: 18px; margin-bottom: 8px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .msg-sent { align-self: flex-end; background: var(--chat-bg-sent); color: white; border-bottom-right-radius: 4px; margin-left: auto; }
        .msg-received { align-self: flex-start; background: var(--chat-bg-received); color: white; border-bottom-left-radius: 4px; }
        
        .chat-list-item { padding: 15px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; cursor: pointer; }
        .chat-list-item:hover { background: rgba(255,255,255,0.03); }

        /* MODALS */
        .modal { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card-bg); border-top: 1px solid var(--border); z-index: 200; padding: 25px; display: none; flex-direction: column; animation: slideUp 0.3s; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); max-height: 80vh; overflow-y: auto; }
        .modal.open { display: flex; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-input-group { margin-bottom: 15px; }
        .modal-input-group label { display: block; color: var(--text-sec); font-size: 12px; margin-bottom: 5px; }

        /* IMAGE VIEWER */
        #img-viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 300; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #img-viewer img { max-width: 100%; max-height: 90%; object-fit: contain; }
        #img-viewer .close-btn { position: absolute; top: 20px; right: 20px; color: white; font-size: 40px; cursor: pointer; }

        .post-options-btn { color: var(--text-sec); cursor: pointer; padding: 5px; font-size: 18px; }
        .post-menu { position: absolute; right: 20px; top: 45px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); display: none; flex-direction: column; z-index: 10; }
        .post-menu.show { display: flex; }
        .pm-item { padding: 10px 20px; cursor: pointer; font-size: 14px; color: var(--text-main); }
        .pm-item:hover { background: var(--border); }
        .pm-item.delete { color: #f4212e; }

        .list-user-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--border); }
        .list-user-item:hover { background: rgba(255,255,255,0.05); }
    </style>
</head>
<body>

    <!-- LOADING SCREEN -->
    <div id="auth-loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:black; color:white; display:flex; align-items:center; justify-content:center; z-index:9999;">
        <div style="text-align:center;">
            <h2 style="font-weight:800; font-size:24px;">Livo</h2>
            <p style="color:#777; font-size:14px; margin-top:5px;">Connecting...</p>
        </div>
    </div>

    <!-- IMAGE VIEWER MODAL -->
    <div id="img-viewer" onclick="this.style.display='none'">
        <div class="close-btn">√ó</div>
        <img id="viewer-img" src="">
    </div>

    <!-- AUTH SECTION -->
    <div id="auth-screen" class="auth-container" style="display:none;">
        <div class="auth-box">
            <div class="auth-title">Livo</div>
            
            <div id="login-form">
                <input type="text" id="l-user" class="auth-input" placeholder="Email or Username">
                <input type="password" id="l-pass" class="auth-input" placeholder="Password">
                <button class="auth-btn" onclick="app.login()">Log in</button>
                <div class="toggle-auth">Don't have an account? <a onclick="app.toggleAuth('register')">Sign up</a></div>
            </div>

            <div id="register-form" style="display:none;">
                <input type="text" id="r-name" class="auth-input" placeholder="Full Name">
                <input type="text" id="r-username" class="auth-input" placeholder="Username (Unique)">
                <input type="email" id="r-email" class="auth-input" placeholder="Email">
                <input type="password" id="r-pass" class="auth-input" placeholder="Password">
                <input type="password" id="r-confirm-pass" class="auth-input" placeholder="Confirm Password">
                <button class="auth-btn" onclick="app.register()">Sign up</button>
                <div class="toggle-auth">Already have an account? <a onclick="app.toggleAuth('login')">Log in</a></div>
            </div>
        </div>
    </div>

    <!-- APP SECTION -->
    <div id="app-screen" style="display:none;">
        <div class="sticky-header">
            <div class="app-header">
                <div class="logo" onclick="app.navTo('home')">Livo</div>
                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" placeholder="Search users, channels..." onkeyup="app.handleSearch(this.value)">
                </div>
                <button class="menu-btn" onclick="document.getElementById('main-menu').classList.toggle('show')">‚ò∞</button>
                <div id="main-menu" class="dropdown-menu">
                    <div class="menu-opt" onclick="app.navTo('profile'); document.getElementById('main-menu').classList.remove('show')">üë§ My Profile</div>
                    <div class="menu-opt" onclick="document.getElementById('modal-edit-profile').classList.add('open'); document.getElementById('main-menu').classList.remove('show')">‚úèÔ∏è Edit Profile</div>
                    <div class="menu-opt" onclick="app.logout()">üö™ Logout</div>
                </div>
            </div>
            
            <div class="top-nav">
                <div class="nav-item active" onclick="app.navTo('home')" id="nav-home">
                    <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                </div>
                <div class="nav-item" onclick="app.navTo('video')" id="nav-video">
                    <svg viewBox="0 0 24 24"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/></svg>
                </div>
                <div class="nav-item" onclick="app.navTo('chat')" id="nav-chat">
                    <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/></svg>
                </div>
                <div class="nav-item" onclick="app.navTo('channel')" id="nav-channel">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                </div>
                <div class="nav-item" onclick="app.navTo('ping')" id="nav-ping">
                    <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
                </div>
            </div>
        </div>

        <div class="container" style="margin-top: 10px;">
            
            <!-- HOME VIEW -->
            <div id="view-home" class="view-section">
                <div class="cp-box">
                    <div class="cp-top-row">
                        <img id="home-avatar" class="cp-avatar-sm" src="" onclick="app.navTo('profile')">
                        <div class="cp-input-container">
                            <textarea id="home-post-input" class="cp-input" placeholder="What's on your mind?" oninput="app.checkPostBtn('home')"></textarea>
                        </div>
                    </div>
                    
                    <div class="cp-tools">
                        <div class="cp-icons-group">
                            <label for="home-img-file" class="cp-tool-btn"><i>üñºÔ∏è</i>Photo</label>
                            <label for="home-vid-file" class="cp-tool-btn"><i>üé•</i>Video</label>
                            <label for="home-vid-file" class="cp-tool-btn live"><i>üì°</i>Live</label>
                        </div>
                        <span id="home-file-status" class="file-status"></span>
                        <button class="cp-btn" id="home-post-btn" onclick="app.createPost('home')">Post</button>
                    </div>
                    <input type="file" id="home-img-file" accept="image/*" onchange="app.handleFileSelect('home', 'img', this)">
                    <input type="file" id="home-vid-file" accept="video/*" onchange="app.handleFileSelect('home', 'vid', this)">
                </div>
                <div id="home-feed"></div>
            </div>

            <!-- VIDEO VIEW -->
            <div id="view-video" class="view-section">
                <div id="video-feed"></div>
            </div>

            <!-- CHAT LIST VIEW -->
            <div id="view-chat" class="view-section">
                <h3 style="padding:15px; border-bottom:1px solid var(--border);">Messages</h3>
                <div id="chat-list"></div>
            </div>
            
             <!-- CHAT DETAIL VIEW -->
             <div id="view-chat-detail" class="view-section">
                <div style="padding:10px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px;">
                    <button onclick="app.navTo('chat')">‚¨Ö Back</button>
                    <div id="chat-header-name" style="font-weight:bold;">User</div>
                </div>
                <div id="chat-messages" class="chat-msg-container"></div>
                <div id="chat-input-row">
                    <input type="text" id="chat-input" placeholder="Type a message..." style="background:#202327; border:none; color:white;">
                    <button class="cp-btn" style="opacity:1;" onclick="app.sendMessage()">Send</button>
                </div>
            </div>

            <!-- SEARCH RESULTS VIEW -->
            <div id="view-search" class="view-section">
                <div class="search-tabs">
                    <div class="s-tab active" onclick="app.switchSearchTab('all')">All</div>
                </div>
                <div id="search-results-list"></div>
            </div>

            <!-- PROFILE VIEW -->
            <div id="view-profile" class="view-section">
                <div id="profile-header-content"></div>
                <div class="cp-box" id="profile-post-box" style="display:none;">
                    <div class="cp-top-row">
                        <img id="profile-avatar" class="cp-avatar-sm" src="" onclick="app.navTo('profile')">
                        <div class="cp-input-container">
                            <textarea id="profile-post-input" class="cp-input" placeholder="What's on your mind?" oninput="app.checkPostBtn('profile')"></textarea>
                        </div>
                    </div>
                    <div class="cp-tools">
                        <div class="cp-icons-group">
                            <label for="profile-img-file" class="cp-tool-btn"><i>üñºÔ∏è</i>Photo</label>
                            <label for="profile-vid-file" class="cp-tool-btn"><i>üé•</i>Video</label>
                            <label for="profile-vid-file" class="cp-tool-btn live"><i>üì°</i>Live</label>
                        </div>
                        <span id="profile-file-status" class="file-status"></span>
                        <button class="cp-btn" id="profile-post-btn" onclick="app.createPost('profile')">Post</button>
                    </div>
                    <input type="file" id="profile-img-file" accept="image/*" onchange="app.handleFileSelect('profile', 'img', this)">
                    <input type="file" id="profile-vid-file" accept="video/*" onchange="app.handleFileSelect('profile', 'vid', this)">
                </div>
                <div id="profile-feed"></div>
            </div>

            <!-- CHANNEL VIEW -->
            <div id="view-channel" class="view-section">
                <div id="channel-header-content"></div>
                <div class="cp-box" id="channel-post-box" style="display:none;">
                    <div class="cp-top-row">
                        <img id="channel-avatar" class="cp-avatar-sm" src="">
                        <div class="cp-input-container">
                            <textarea id="channel-post-input" class="cp-input" placeholder="Broadcast to Channel..." oninput="app.checkPostBtn('channel')"></textarea>
                        </div>
                    </div>
                    <div class="cp-tools">
                        <div class="cp-icons-group">
                            <label for="channel-img-file" class="cp-tool-btn"><i>üñºÔ∏è</i>Photo</label>
                            <label for="channel-vid-file" class="cp-tool-btn"><i>üé•</i>Video</label>
                            <label for="channel-vid-file" class="cp-tool-btn live"><i>üì°</i>Live</label>
                        </div>
                        <span id="channel-file-status" class="file-status"></span>
                        <button class="cp-btn" id="channel-post-btn" onclick="app.createPost('channel')">Post</button>
                    </div>
                    <input type="file" id="channel-img-file" accept="image/*" onchange="app.handleFileSelect('channel', 'img', this)">
                    <input type="file" id="channel-vid-file" accept="video/*" onchange="app.handleFileSelect('channel', 'vid', this)">
                </div>
                <div id="channel-feed"></div>
            </div>

            <div id="view-channel-list" class="view-section">
                <div style="display:flex; justify-content:space-between; align-items:center; padding:15px;">
                    <h3>Channels</h3>
                    <button class="cp-btn" style="opacity:1; pointer-events:auto;" onclick="app.openCreateChannel()">+ Create</button>
                </div>
                <div id="all-channels-list"></div>
            </div>

             <div id="view-ping" class="view-section">
                <h3 style="padding:15px; border-bottom:1px solid var(--border);">Notifications</h3>
                <div id="ping-list"></div>
            </div>

        </div>
    </div>

    <!-- MODAL: CREATE CHANNEL -->
    <div id="modal-create-channel" class="modal">
        <div class="modal-head" style="font-size:18px; font-weight:bold; margin-bottom:15px; display:flex; justify-content:space-between;">
            <span>Create Channel</span>
            <span onclick="document.getElementById('modal-create-channel').classList.remove('open')" style="cursor:pointer;">√ó</span>
        </div>
        <input type="text" id="new-chan-name" class="auth-input" placeholder="Channel Name">
        <textarea id="new-chan-bio" class="auth-input" placeholder="Description"></textarea>
        <button class="auth-btn" onclick="app.submitCreateChannel()">Create</button>
    </div>

    <!-- MODAL: EDIT PROFILE -->
    <div id="modal-edit-profile" class="modal">
        <div class="modal-head" style="font-size:18px; font-weight:bold; margin-bottom:15px; display:flex; justify-content:space-between;">
            <span>Edit Profile</span>
            <span onclick="document.getElementById('modal-edit-profile').classList.remove('open')" style="cursor:pointer;">√ó</span>
        </div>
        <div class="modal-input-group">
            <label>Name</label>
            <input type="text" id="edit-name" class="auth-input">
        </div>
        <div class="modal-input-group">
            <label>Bio</label>
            <textarea id="edit-bio" class="auth-input" rows="3"></textarea>
        </div>
        <div class="modal-input-group">
            <label>Location</label>
            <input type="text" id="edit-location" class="auth-input">
        </div>
        <div class="modal-input-group">
            <label>Website</label>
            <input type="text" id="edit-website" class="auth-input">
        </div>
        <button class="auth-btn" onclick="app.saveProfileChanges()">Save</button>
    </div>

    <!-- MODAL: FOLLOWERS/FOLLOWING -->
    <div id="modal-users-list" class="modal">
        <div class="modal-head" style="font-size:18px; font-weight:bold; margin-bottom:15px; display:flex; justify-content:space-between;">
            <span id="modal-users-title">List</span>
            <span onclick="document.getElementById('modal-users-list').classList.remove('open')" style="cursor:pointer;">√ó</span>
        </div>
        <div id="modal-users-content"></div>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, query, where, onSnapshot, orderBy, setDoc, getDoc, getDocs, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-storage.js";

        // ==========================================
        // YOUR CONFIG
        // ==========================================
        const firebaseConfig = {
    apiKey: "AIzaSyAKqNt9KLTVy3OXiLVmJGyADzdnQQ_cASE",
    authDomain: "livoapp-dc2da.firebaseapp.com",
    projectId: "livoapp-dc2da",
    storageBucket: "livoapp-dc2da.firebasestorage.app",
    messagingSenderId: "178266701059",
    appId: "1:178266701059:web:23775265b7dc81b765fd36",
    measurementId: "G-6Y6VZZ6RHR"
 };

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const storage = getStorage(fbApp);

        let currentUserData = null; 
        let activeListeners = [];
        let pendingFiles = {};
        let currentChatUserId = null;
        let currentChatId = null;

        const app = {
            state: { currentView: 'home', viewingProfileId: null, viewingChannelId: null, searchTab: 'all' },

            init: function() {
                onAuthStateChanged(auth, async (user) => {
                    const loader = document.getElementById('auth-loader');
                    if(loader) loader.style.display = 'none';

                    if (user) {
                        await this.loadUserProfile(user.uid);
                    } else {
                        document.getElementById('auth-screen').style.display = 'flex';
                        document.getElementById('app-screen').style.display = 'none';
                        this.cleanupListeners();
                    }
                });
            },

            cleanupListeners: function() {
                activeListeners.forEach(unsub => unsub());
                activeListeners = [];
            },

            loadUserProfile: async function(uid) {
                const docRef = doc(db, "users", uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    currentUserData = { id: docSnap.id, ...docSnap.data() };
                    this.listenToNotifications();
                    this.showApp();
                }
            },

            toggleAuth: (type) => {
                document.getElementById('login-form').style.display = type === 'login' ? 'block' : 'none';
                document.getElementById('register-form').style.display = type === 'register' ? 'block' : 'none';
            },

            login: async function() {
                const input = document.getElementById('l-user').value.trim(); 
                const pass = document.getElementById('l-pass').value.trim();
                
                if(!input || !pass) return alert("Please fill all fields");

                let emailToUse = input;

                if (!input.includes('@')) {
                    try {
                        const q = query(collection(db, "users"), where("username", "==", input.toLowerCase()));
                        const snap = await getDocs(q);
                        if (snap.empty) {
                            return alert("User not found");
                        }
                        emailToUse = snap.docs[0].data().email;
                    } catch (e) {
                        console.error(e);
                        return alert("Error finding user");
                    }
                }

                try {
                    await signInWithEmailAndPassword(auth, emailToUse, pass);
                } catch (error) {
                    alert("Login failed: " + error.message);
                }
            },

            register: async function() {
                const name = document.getElementById('r-name').value.trim();
                const username = document.getElementById('r-username').value.trim();
                const email = document.getElementById('r-email').value.trim();
                const pass = document.getElementById('r-pass').value.trim();
                const confirmPass = document.getElementById('r-confirm-pass').value.trim();

                if(!name || !username || !email || !pass || !confirmPass) return alert("All fields required");
                if(pass !== confirmPass) return alert("Passwords do not match");
                if(username.includes(' ')) return alert("Username cannot contain spaces");

                try {
                    const q = query(collection(db, "users"), where("username", "==", username.toLowerCase()));
                    const snap = await getDocs(q);
                    if(!snap.empty) return alert("Username is already taken");

                    const cred = await createUserWithEmailAndPassword(auth, email, pass);

                    const newUser = {
                        uid: cred.user.uid,
                        email: email,
                        name: name,
                        username: username.toLowerCase(), 
                        bio: "Hello Livo!", 
                        location: "",
                        website: "",
                        avatar: `https://picsum.photos/seed/${cred.user.uid}/200/200`, 
                        cover: `https://picsum.photos/seed/${cred.user.uid}cover/600/200`,
                        following: [],
                        followers: []
                    };
                    await setDoc(doc(db, "users", cred.user.uid), newUser);
                } catch (error) {
                    alert(error.message);
                }
            },

            logout: () => signOut(auth),

            showApp: function() {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'block';
                document.getElementById('home-avatar').src = currentUserData.avatar;
                this.navTo('home');
            },

            navTo: function(viewName) {
                this.state.currentView = viewName;
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const navEl = document.getElementById('nav-' + viewName);
                if(navEl) navEl.classList.add('active');
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                
                this.cleanupListeners();

                if(viewName === 'home') { 
                    document.getElementById('view-home').classList.add('active'); 
                    this.listenToFeed('home'); 
                } else if (viewName === 'video') { 
                    document.getElementById('view-video').classList.add('active'); 
                    this.listenToFeed('video'); 
                } else if (viewName === 'chat') { 
                    document.getElementById('view-chat').classList.add('active'); 
                    this.loadChatList(); 
                } else if (viewName === 'channel') { 
                    document.getElementById('view-channel-list').classList.add('active'); 
                    this.listenToChannels(); 
                } else if (viewName === 'ping') { 
                    document.getElementById('view-ping').classList.add('active'); 
                } else if (viewName === 'profile') { 
                    this.openProfile(currentUserData.id); 
                } else if (viewName === 'search') { 
                    document.getElementById('view-search').classList.add('active'); 
                }
            },

            handleFileSelect: function(context, type, fileInput) {
                const file = fileInput.files[0];
                if(!file) return;
                const btn = document.getElementById(context + '-post-btn');
                const statusSpan = document.getElementById(context + '-file-status');
                if(type === 'img') document.getElementById(context + '-vid-file').value = "";
                if(type === 'vid') document.getElementById(context + '-img-file').value = "";
                pendingFiles[context] = file;
                btn.dataset.fileType = type; 
                btn.dataset.hasFile = "true";
                btn.classList.add('ready');
                statusSpan.innerText = type === 'img' ? "Image" : "Video";
                statusSpan.style.display = "block";
            },

            openEditProfileModal: function() {
                document.getElementById('edit-name').value = currentUserData.name;
                document.getElementById('edit-bio').value = currentUserData.bio;
                document.getElementById('edit-location').value = currentUserData.location || '';
                document.getElementById('edit-website').value = currentUserData.website || '';
                document.getElementById('modal-edit-profile').classList.add('open');
            },

            saveProfileChanges: async function() {
                const newName = document.getElementById('edit-name').value;
                const newBio = document.getElementById('edit-bio').value;
                const newLoc = document.getElementById('edit-location').value;
                const newWeb = document.getElementById('edit-website').value;
                if(!newName) return alert("Name cannot be empty");

                const userRef = doc(db, "users", currentUserData.id);
                await updateDoc(userRef, {
                    name: newName,
                    bio: newBio,
                    location: newLoc,
                    website: newWeb
                });
                
                currentUserData.name = newName;
                currentUserData.bio = newBio;
                currentUserData.location = newLoc;
                currentUserData.website = newWeb;

                document.getElementById('modal-edit-profile').classList.remove('open');
                this.openProfile(currentUserData.id);
            },

            updateProfileImage: async function(type, input) {
                const file = input.files[0];
                if(!file) return;
                try {
                    const storageRef = ref(storage, `users/${currentUserData.id}/${type}_${Date.now()}`);
                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);

                    const userRef = doc(db, "users", currentUserData.id);
                    const updateData = {};
                    if(type === 'avatar') updateData.avatar = url;
                    else if(type === 'cover') updateData.cover = url;
                    
                    await updateDoc(userRef, updateData);
                    if(type === 'avatar') currentUserData.avatar = url;
                    else currentUserData.cover = url;
                    
                    this.openProfile(currentUserData.id); 
                } catch(e) {
                    console.error(e);
                    alert("Image upload failed: " + e.message);
                }
            },

            clearFile: function(context) {
                const btn = document.getElementById(context + '-post-btn');
                document.getElementById(context + '-img-file').value = "";
                document.getElementById(context + '-vid-file').value = "";
                delete pendingFiles[context];
                delete btn.dataset.fileType;
                delete btn.dataset.hasFile;
                btn.classList.remove('ready');
                document.getElementById(context + '-file-status').innerText = "";
                document.getElementById(context + '-file-status').style.display = "none";
            },

            checkPostBtn: function(context) {
                const text = document.getElementById(context + '-post-input').value;
                const btn = document.getElementById(context + '-post-btn');
                if(text.trim().length > 0 || btn.dataset.hasFile) {
                    btn.classList.add('ready');
                } else {
                    if(!btn.dataset.hasFile) btn.classList.remove('ready');
                }
            },

            createPost: async function(context) {
                let text="", media=null, type='post', isChannel=false, channelId=null, authorName=currentUserData.name, authorId=currentUserData.id, authorUsername=currentUserData.username; 
                
                if(context === 'home') { text = document.getElementById('home-post-input').value; } 
                else if (context === 'profile') { text = document.getElementById('profile-post-input').value; isChannel=false; } 
                else if (context === 'channel') { 
                    channelId = this.state.viewingChannelId; 
                    // GET REAL CHANNEL NAME
                    const snap = await getDoc(doc(db, "channels", channelId));
                    if(snap.exists()) {
                        authorName = snap.data().name; 
                    }
                    isChannel = true; 
                }
                
                const btn = document.getElementById(context + '-post-btn');
                
                if(btn.dataset.hasFile) {
                    const file = pendingFiles[context];
                    const fileType = btn.dataset.fileType;
                    
                    try {
                        const fileName = `${context}_${Date.now()}_${file.name}`;
                        const storageRef = ref(storage, `posts/${fileName}`);
                        document.getElementById(context + '-file-status').innerText = "Uploading...";
                        await uploadBytes(storageRef, file);
                        media = await getDownloadURL(storageRef);
                        type = fileType === 'vid' ? 'video' : 'post';
                    } catch (error) {
                        console.error(error);
                        alert("Upload failed: " + error.message);
                        return;
                    }
                }

                if(!text && !media) return alert("Empty content");

                const newPost = { 
                    authorId, authorName, authorUsername, isChannel, channelId, 
                    content: text, media, type, 
                    likes: 0, likedBy: [], comments: [], 
                    timestamp: Date.now() 
                };

                try {
                    await addDoc(collection(db, "posts"), newPost);
                    
                    if(context === 'home') { document.getElementById('home-post-input').value = ""; this.clearFile('home'); }
                    if(context === 'profile') { document.getElementById('profile-post-input').value = ""; this.clearFile('profile'); }
                    if(context === 'channel') { document.getElementById('channel-post-input').value = ""; this.clearFile('channel'); }
                } catch(e) { alert(e.message); }
            },

            deletePost: async function(postId) {
                if(!confirm("Delete this post?")) return;
                await deleteDoc(doc(db, "posts", postId));
            },

            editPost: async function(postId) {
                const newText = prompt("Edit caption:", ""); 
                if(newText !== null) {
                    await updateDoc(doc(db, "posts", postId), { content: newText });
                }
            },

            toggleLike: async function(postId, btnElement) {
                const postRef = doc(db, "posts", postId);
                const uid = currentUserData.id;
                
                const snap = await getDoc(postRef);
                if(snap.exists()) {
                    const data = snap.data();
                    const likes = data.likedBy || [];
                    if(likes.includes(uid)) {
                        await updateDoc(postRef, { likedBy: arrayRemove(uid), likes: (data.likes || 1) - 1 });
                    } else {
                        await updateDoc(postRef, { likedBy: arrayUnion(uid), likes: (data.likes || 0) + 1 });
                        if(data.authorId !== uid && !data.isChannel) {
                            this.addNotification(data.authorId, 'like', `${currentUserData.name} liked your post.`);
                        }
                    }
                }
            },

            addNotification: async function(toUserId, type, text) {
                await addDoc(collection(db, "notifications"), {
                    toUserId, type, text, timestamp: Date.now(), read: false
                });
            },

            listenToNotifications: function() {
                const list = document.getElementById('ping-list');
                const q = query(collection(db, "notifications"), where("toUserId", "==", currentUserData.id), orderBy("timestamp", "desc"));
                
                const unsub = onSnapshot(q, (snapshot) => {
                    list.innerHTML = '';
                    if(snapshot.empty) {
                        list.innerHTML = "<div style='padding:20px; text-align:center; color:#777;'>No notifications</div>";
                        return;
                    }
                    snapshot.forEach(doc => {
                        const n = doc.data();
                        const isRecent = (Date.now() - n.timestamp) < 60000; 
                        const timeStr = isRecent ? "Just now" : new Date(n.timestamp).toLocaleString();
                        
                        list.innerHTML += `
                        <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; gap:10px; align-items:start; ${n.read ? 'opacity:0.6' : ''}">
                            <div style="background:var(--accent); width:8px; height:8px; border-radius:50%; margin-top:6px; ${n.read ? 'display:none' : ''}"></div>
                            <div>
                                <div style="font-size:15px;">${n.text}</div>
                                <div style="font-size:12px; color:var(--text-sec);">${timeStr}</div>
                            </div>
                        </div>`;
                    });
                });
                activeListeners.push(unsub);
            },

            submitComment: async function(postId, inputId) {
                const input = document.getElementById(inputId);
                const text = input.value.trim();
                if(!text) return;
                
                const comment = { id: Date.now(), authorName: currentUserData.name, text: text, timestamp: Date.now() }; 
                await updateDoc(doc(db, "posts", postId), {
                    comments: arrayUnion(comment)
                });
                
                const snap = await getDoc(doc(db, "posts", postId));
                if(snap.exists()) {
                    const data = snap.data();
                    if(data.authorId !== currentUserData.id && !data.isChannel) {
                        this.addNotification(data.authorId, 'comment', `${currentUserData.name} commented on your post.`);
                    }
                }

                input.value = "";
                setTimeout(() => {
                    const section = document.getElementById(`comments-${postId}`);
                    if(section) section.classList.add('open');
                }, 50);
            },

            toggleFollow: async function(targetId, isChannel, btnElement, feedContext) {
                if(targetId === currentUserData.id && !isChannel) return;
                
                if(isChannel) {
                    const chanRef = doc(db, "channels", targetId);
                    const snap = await getDoc(chanRef);
                    if(snap.exists()) {
                        const followers = snap.data().followers || [];
                        if(followers.includes(currentUserData.id)) {
                            await updateDoc(chanRef, { followers: arrayRemove(currentUserData.id) });
                            if(btnElement) { btnElement.innerText = "Follow"; btnElement.classList.remove('following'); btnElement.style.background = 'var(--card-bg)'; btnElement.style.color='var(--text-main)'; }
                        } else {
                            await updateDoc(chanRef, { followers: arrayUnion(currentUserData.id) });
                            if(btnElement) { btnElement.innerText = "Following"; btnElement.classList.add('following'); btnElement.style.background = 'white'; btnElement.style.color='black'; }
                        }
                    }
                } else {
                    const myRef = doc(db, "users", currentUserData.id);
                    const targetRef = doc(db, "users", targetId);
                    
                    const mySnap = await getDoc(myRef);
                    const myFollowing = mySnap.data().following || [];
                    
                    if(myFollowing.includes(targetId)) {
                        await updateDoc(myRef, { following: arrayRemove(targetId) });
                        await updateDoc(targetRef, { followers: arrayRemove(currentUserData.id) });
                        if(btnElement) { 
                             if(feedContext) {
                                 btnElement.style.display = 'none'; 
                             } else {
                                btnElement.innerText = "Follow"; btnElement.classList.remove('following'); btnElement.style.background = 'var(--card-bg)'; btnElement.style.color='var(--text-main)';
                             }
                        }
                    } else {
                        await updateDoc(myRef, { following: arrayUnion(targetId) });
                        await updateDoc(targetRef, { followers: arrayUnion(currentUserData.id) });
                        if(btnElement) { 
                             if(feedContext) {
                                 btnElement.style.display = 'none';
                             } else {
                                btnElement.innerText = "Following"; btnElement.classList.add('following'); btnElement.style.background = 'white'; btnElement.style.color='black';
                             }
                        }
                    }
                }
            },

            // FOLLOWERS/FOLLOWING LIST LOGIC
            openFollowersModal: async function(uid) {
                document.getElementById('modal-users-title').innerText = "Followers";
                const list = document.getElementById('modal-users-content');
                list.innerHTML = "Loading...";
                document.getElementById('modal-users-list').classList.add('open');
                
                const uRef = doc(db, "users", uid);
                const uSnap = await getDoc(uRef);
                if(uSnap.exists()){
                    const followers = uSnap.data().followers || [];
                    if(followers.length === 0) list.innerHTML = "No followers";
                    else {
                        list.innerHTML = '';
                        for(let fid of followers) {
                            const fSnap = await getDoc(doc(db, "users", fid));
                            if(fSnap.exists()){
                                const f = fSnap.data();
                                list.innerHTML += `<div class="list-user-item"><img src="${f.avatar}" style="width:40px;height:40px;border-radius:50%;"><div>${f.name}</div></div>`;
                            }
                        }
                    }
                }
            },
            openFollowingModal: async function(uid) {
                document.getElementById('modal-users-title').innerText = "Following";
                const list = document.getElementById('modal-users-content');
                list.innerHTML = "Loading...";
                document.getElementById('modal-users-list').classList.add('open');

                const uRef = doc(db, "users", uid);
                const uSnap = await getDoc(uRef);
                if(uSnap.exists()){
                    const following = uSnap.data().following || [];
                    if(following.length === 0) list.innerHTML = "Not following anyone";
                    else {
                        list.innerHTML = '';
                        for(let fid of following) {
                            const fSnap = await getDoc(doc(db, "users", fid));
                            if(fSnap.exists()){
                                const f = fSnap.data();
                                list.innerHTML += `<div class="list-user-item"><img src="${f.avatar}" style="width:40px;height:40px;border-radius:50%;"><div>${f.name}</div></div>`;
                            }
                        }
                    }
                }
            },

            // CHAT SYSTEM
            loadChatList: function() {
                const list = document.getElementById('chat-list');
                list.innerHTML = "";
                const myFollowing = currentUserData.following || [];
                if(myFollowing.length === 0) {
                    list.innerHTML = "<div style='padding:20px;text-align:center'>Follow users to chat with them.</div>";
                    return;
                }
                
                myFollowing.forEach(fid => {
                    getDoc(doc(db, "users", fid)).then(snap => {
                        if(snap.exists()) {
                            const u = snap.data();
                            const item = document.createElement('div');
                            item.className = "chat-list-item";
                            item.innerHTML = `<img src="${u.avatar}" class="pc-avatar"><div style="flex:1"><div style="font-weight:bold">${u.name}</div><div style="color:#777;font-size:13px">@${u.username}</div></div>`;
                            item.onclick = () => app.startChat(fid, u.name, u.avatar);
                            list.appendChild(item);
                        }
                    });
                });
            },
            
            startChat: function(targetId, name, avatar) {
                currentChatUserId = targetId;
                currentChatId = [currentUserData.id, targetId].sort().join('_');
                
                document.getElementById('chat-header-name').innerText = name;
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById('view-chat-detail').classList.add('active');
                
                const msgContainer = document.getElementById('chat-messages');
                const q = query(collection(db, "chats", currentChatId, "messages"), orderBy("timestamp", "asc"));
                const unsub = onSnapshot(q, (snap) => {
                    msgContainer.innerHTML = "";
                    snap.forEach(d => {
                        const m = d.data();
                        const isMe = m.senderId === currentUserData.id;
                        const bubble = document.createElement('div');
                        bubble.className = `msg-bubble ${isMe ? 'msg-sent' : 'msg-received'}`;
                        bubble.innerText = m.text;
                        msgContainer.appendChild(bubble);
                    });
                    msgContainer.scrollTop = msgContainer.scrollHeight;
                });
                activeListeners.push(unsub);
            },
            
            sendMessage: async function() {
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                if(!text || !currentChatId) return alert("Error: Chat session not started.");

                try {
                    await addDoc(collection(db, "chats", currentChatId, "messages"), {
                        senderId: currentUserData.id,
                        text: text,
                        timestamp: Date.now()
                    });
                    input.value = "";
                } catch (e) {
                    console.error(e);
                    alert("Failed to send message: " + e.message);
                }
            },

            timeAgo: function(timestamp) {
                const seconds = Math.floor((new Date() - timestamp) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + "y";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + "mo";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + "d";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + "h";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + "m";
                return "Just now";
            },

            listenToFeed: function(viewType) {
                const containerId = viewType === 'video' ? 'video-feed' : 'home-feed';
                const container = document.getElementById(containerId);
                
                let q = query(collection(db, "posts"), orderBy("timestamp", "desc"));

                const unsub = onSnapshot(q, (snapshot) => {
                    container.innerHTML = '';
                    let posts = [];
                    snapshot.forEach(doc => posts.push({id: doc.id, ...doc.data()}));
                    
                    if(viewType === 'video') posts = posts.filter(p => p.type === 'video');
                    if(posts.length === 0) container.innerHTML = "<div style='padding:20px;text-align:center;color:#777'>No posts yet</div>";

                    posts.forEach(post => { 
                        container.innerHTML += this.buildPostHTML(post, viewType); 
                    });
                });
                
                activeListeners.push(unsub);
            },

            listenToChannels: function() {
                const list = document.getElementById('all-channels-list');
                const q = query(collection(db, "channels"), orderBy("timestamp", "desc"));
                
                const unsub = onSnapshot(q, (snapshot) => {
                    list.innerHTML = '';
                    snapshot.forEach(doc => {
                        const c = doc.data();
                        list.innerHTML += `<div class="search-result-item" onclick="app.openChannel('${doc.id}')"><img src="${c.cover || c.avatar}" class="pc-avatar" style="border-radius:8px;"><div><div style="font-weight:bold;">${c.name} <span class="badge-channel">Channel</span></div><div style="color:var(--text-sec); font-size:13px;">${c.bio.substring(0,40)}...</div></div></div>`;
                    });
                });
                activeListeners.push(unsub);
            },

            buildPostHTML: function(post, viewType) {
                const isChannel = post.isChannel;
                const isMyPost = post.authorId === currentUserData.id || (isChannel && post.authorId === currentUserData.id); 
                
                let avatarUrl = post.authorId ? `https://picsum.photos/seed/${post.authorId}/200/200` : `https://picsum.photos/seed/livo/200/200`;
                
                const nameClick = isChannel ? `onclick="app.openChannel('${post.channelId}')"` : `onclick="app.openProfile('${post.authorId}')"`;
                const avatarClick = nameClick;

                let mediaHTML = '';
                if(post.media) {
                    const mediaClass = post.type === 'video' ? 'vid-mode' : 'img-mode';
                    if(post.type === 'video') {
                        mediaHTML = `<div class="pc-media-wrapper ${mediaClass}"><video controls src="${post.media}"></video></div>`;
                    } else {
                        mediaHTML = `<div class="pc-media-wrapper ${mediaClass}"><img src="${post.media}"></div>`;
                    }
                }

                // FOLLOW BUTTON IN FEED
                let followBtnHTML = '';
                if(!isMyPost && !isChannel && post.authorId !== currentUserData.id) { 
                    const isFollowing = currentUserData.following && currentUserData.following.includes(post.authorId);
                    if(!isFollowing) {
                        // Add Username to Button
                        const targetUserRef = document.getElementById(`post-username-${post.authorId}`);
                        const displayName = targetUserRef ? targetUserRef.innerText : "Follow";
                        followBtnHTML = `<button class="follow-btn-small" onclick="event.stopPropagation(); app.toggleFollow('${post.authorId}', false, this, true)">Follow</button>`;
                    }
                }

                let optionsMenu = '';
                if(isMyPost) {
                    optionsMenu = `
                        <div class="post-options-btn" onclick="event.stopPropagation(); this.nextElementSibling.classList.toggle('show');">‚ãÆ</div>
                        <div class="post-menu" onclick="event.stopPropagation(); this.classList.remove('show');">
                            <div class="pm-item" onclick="app.editPost('${post.id}')">Edit Caption</div>
                            <div class="pm-item delete" onclick="app.deletePost('${post.id}')">Delete Post</div>
                        </div>
                    `;
                }

                const commentsHTML = post.comments ? post.comments.map(c => `
                    <div class="comment-item">
                        <div style="flex:1;">
                            <div class="comment-author">${c.authorName}</div>
                            <div>${c.text}</div>
                        </div>
                    </div>
                `).join('') : '';

                const isLiked = post.likedBy && post.likedBy.includes(currentUserData.id);
                const likeClass = isLiked ? "liked" : "";
                const timeString = this.timeAgo(post.timestamp);

                return `
                <div class="post-card" onclick="document.querySelectorAll('.post-menu').forEach(m=>m.classList.remove('show'))">
                    <div class="pc-header">
                        <div class="pc-user-info">
                            <img src="${avatarUrl}" class="pc-avatar" ${avatarClick}>
                            <div class="pc-meta">
                                <div class="pc-top-line">
                                    <div class="pc-name" ${nameClick}>${post.authorName}</div>
                                    ${followBtnHTML}
                                </div>
                                <div class="pc-time">${timeString}</div>
                            </div>
                        </div>
                        ${optionsMenu}
                    </div>
                    
                    <div class="pc-text" onclick="${isChannel ? `app.openChannel('${post.channelId}')` : `app.openProfile('${post.authorId}')`}">${post.content}</div>
                    ${mediaHTML}
                    
                    <div class="pc-actions">
                        <div class="action-item like ${likeClass}" onclick="app.toggleLike('${post.id}', this)">
                            <i style="font-style:normal;">‚ù§Ô∏è</i> <span>${post.likes || 0}</span>
                        </div>
                        <div class="action-item comment" onclick="document.getElementById('comments-${post.id}').classList.toggle('open')">
                            <i style="font-style:normal;">üí¨</i> <span>${post.comments ? post.comments.length : 0}</span>
                        </div>
                        <div class="action-item">
                            <i style="font-style:normal;">üîó</i>
                        </div>
                    </div>

                    <div id="comments-${post.id}" class="comments-section">
                        ${commentsHTML}
                        <div class="comment-input-wrapper">
                            <img src="${currentUserData.avatar}" class="cp-avatar-sm" style="width:24px;height:24px;">
                            <input type="text" class="comment-input" id="input-${post.id}" placeholder="Write a comment..." onkeydown="if(event.key==='Enter') app.submitComment('${post.id}', 'input-${post.id}')">
                            <button class="comment-btn" onclick="app.submitComment('${post.id}', 'input-${post.id}')">Reply</button>
                        </div>
                    </div>
                </div>
                `;
            },

            openProfile: async function(uid) {
                this.state.viewingProfileId = uid; 
                this.state.viewingChannelId = null;
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById('view-profile').classList.add('active');
                
                let user = null;
                if(uid === currentUserData.id) {
                    user = currentUserData;
                } else {
                    const snap = await getDoc(doc(db, "users", uid));
                    if(snap.exists()) user = {id: snap.id, ...snap.data()};
                }

                if(!user) return;

                const isMe = user.id === currentUserData.id;
                const coverSrc = user.cover || user.avatar; 
                const followCount = user.followers ? user.followers.length : 0;
                const followingCount = user.following ? user.following.length : 0;
                const isFollowing = currentUserData.following && currentUserData.following.includes(user.id);
                
                let actionBtn = '';
                let extraActions = '';
                
                if(!isMe) {
                    // Update Follow Button Text to include Username
                    const btnText = isFollowing ? "Following" : `Follow @${user.username}`;
                    const btnStyle = isFollowing ? "background: white; color: black;" : "";
                    actionBtn = `<button class="edit-btn" style="${btnStyle}" onclick="app.toggleFollow('${user.id}', false, this)">${btnText}</button>`;
                    
                    extraActions = `
                    <button class="btn-secondary" onclick="app.startChat('${user.id}', '${user.name}', '${user.avatar}')">Message</button>
                    <button class="more-btn" onclick="event.stopPropagation(); document.getElementById('profile-menu').classList.toggle('show')">‚ãÆ</button>
                    <div id="profile-menu" class="profile-menu" onclick="event.stopPropagation(); this.classList.remove('show')">
                         <div class="pm-item" onclick="navigator.clipboard.writeText('@${user.username}')">Share</div>
                         <div class="pm-item report" onclick="alert('Reported User @${user.username}')">Report</div>
                    </div>
                    `;
                } else {
                    actionBtn = `<button class="edit-btn profile-edit-btn" onclick="app.openEditProfileModal()">Edit Profile</button>`;
                }

                const headerHTML = `
                    <div class="profile-header">
                        <div class="cover-wrapper" onclick="document.getElementById('viewer-img').src='${coverSrc}'; document.getElementById('img-viewer').style.display='flex'">
                            <img src="${coverSrc}" class="cover-pic">
                            ${isMe ? `<input type="file" id="cover-upload" accept="image/*" onchange="app.updateProfileImage('cover', this)" style="display:none"><div class="cover-upload-trigger" onclick="event.stopPropagation(); document.getElementById('cover-upload').click()">üì∑</div>` : ''}
                        </div>
                        <div class="profile-pic-wrapper">
                            <img src="${user.avatar}" class="profile-pic" onclick="document.getElementById('viewer-img').src='${user.avatar}'; document.getElementById('img-viewer').style.display='flex'">
                            ${isMe ? `<input type="file" id="avatar-upload" accept="image/*" onchange="app.updateProfileImage('avatar', this)" style="display:none"><div class="avatar-upload-trigger" onclick="event.stopPropagation(); document.getElementById('avatar-upload').click()">üì∑</div>` : ''}
                        </div>
                        <div class="ph-details">
                            <div class="ph-top-row">
                                <div>
                                    <div class="ph-name">${user.name}</div>
                                    <div style="font-size:13px; font-weight:600; color:var(--text-sec);">@${user.username}</div>
                                </div>
                                <div style="display:flex; gap:10px; align-items:center;">
                                    ${actionBtn}
                                    ${extraActions}
                                </div>
                            </div>
                            <div class="ph-meta-stats">
                                <div onclick="app.openFollowersModal('${user.id}')"><span class="ph-stat-count">${followCount}</span> <span class="ph-stat-label">followers</span></div>
                                <div onclick="app.openFollowingModal('${user.id}')"><span class="ph-stat-count">${followingCount}</span> <span class="ph-stat-label">following</span></div>
                            </div>
                            <div class="ph-bio">${user.bio}</div>
                            <div class="ph-meta">
                                <span>üìç ${user.location || 'Earth'}</span>
                                <span>üîó ${user.website || 'livo.com'}</span>
                            </div>
                        </div>
                    </div>`;
                document.getElementById('profile-header-content').innerHTML = headerHTML;
                
                const postBox = document.getElementById('profile-post-box');
                document.getElementById('profile-avatar').src = user.avatar;
                if(isMe) { postBox.style.display = 'flex'; } else { postBox.style.display = 'none'; }

                this.cleanupListeners();
                const feedContainer = document.getElementById('profile-feed');
                const q = query(collection(db, "posts"), where("authorId", "==", uid), orderBy("timestamp", "desc"));
                const unsub = onSnapshot(q, (snapshot) => {
                    feedContainer.innerHTML = '';
                    let posts = [];
                    snapshot.forEach(doc => posts.push({id: doc.id, ...doc.data()}));
                    const feedHTML = posts.map(p => this.buildPostHTML(p)).join('');
                    feedContainer.innerHTML = feedHTML || "<div style='padding:40px;text-align:center;color:#777'>No posts yet</div>";
                });
                activeListeners.push(unsub);
            },

            openChannel: async function(chanId) {
                this.state.viewingChannelId = chanId; 
                this.state.viewingProfileId = null;
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById('view-channel').classList.add('active');
                
                const snap = await getDoc(doc(db, "channels", chanId));
                if(!snap.exists()) return alert("Channel not found");
                const chan = {id: snap.id, ...snap.data()};

                const isOwner = chan.ownerId === currentUserData.id;
                const coverSrc = chan.cover || chan.avatar;

                let extraActions = '';
                if(!isOwner) {
                    extraActions = `
                    <button class="btn-secondary" onclick="app.startChat('${chan.ownerId}', '${chan.name}', '${chan.avatar}')">Message</button>
                    <button class="more-btn" onclick="event.stopPropagation(); document.getElementById('channel-menu').classList.toggle('show')">‚ãÆ</button>
                    <div id="channel-menu" class="profile-menu" onclick="event.stopPropagation(); this.classList.remove('show')">
                         <div class="pm-item" onclick="alert('Share Link: ${chan.name}')">Share</div>
                         <div class="pm-item report" onclick="alert('Reported Channel ${chan.name}')">Report</div>
                    </div>
                    `;
                }

                const headerHTML = `
                    <div class="profile-header">
                        <div class="cover-wrapper">
                             <img src="${coverSrc}" class="cover-pic">
                        </div>
                        <div class="profile-pic-wrapper">
                             <img src="${chan.avatar}" class="profile-pic">
                        </div>
                        <div class="ph-details">
                            <div class="ph-top-row">
                                <div>
                                    <div class="ph-name">${chan.name} <span class="badge-channel">Channel</span></div>
                                </div>
                                <div style="display:flex; gap:10px; align-items:center;">
                                    ${isOwner ? `<button class="edit-btn profile-edit-btn">Owner</button>` : `<button class="edit-btn" style="background:white; color:black; border:none;" onclick="app.toggleFollow('${chan.id}', true, this)">Follow</button>`}
                                    ${extraActions}
                                </div>
                            </div>
                            <div class="ph-bio">${chan.bio}</div>
                        </div>
                    </div>`;
                document.getElementById('channel-header-content').innerHTML = headerHTML;
                
                const postBox = document.getElementById('channel-post-box');
                document.getElementById('channel-avatar').src = chan.avatar;
                if(isOwner) { postBox.style.display = 'flex'; } else { postBox.style.display = 'none'; }
                
                this.cleanupListeners();
                const feedContainer = document.getElementById('channel-feed');
                const q = query(collection(db, "posts"), where("channelId", "==", chanId), orderBy("timestamp", "desc"));
                const unsub = onSnapshot(q, (snapshot) => {
                    feedContainer.innerHTML = '';
                    let posts = [];
                    snapshot.forEach(doc => posts.push({id: doc.id, ...doc.data()}));
                    const feedHTML = posts.map(p => this.buildPostHTML(p)).join('');
                    feedContainer.innerHTML = feedHTML || "<div style='padding:40px;text-align:center;color:#777'>No posts in this channel</div>";
                });
                activeListeners.push(unsub);
            },

            openCreateChannel: function() { document.getElementById('modal-create-channel').classList.add('open'); },

            submitCreateChannel: async function() {
                const name = document.getElementById('new-chan-name').value;
                const bio = document.getElementById('new-chan-bio').value;
                if(!name) return alert("Name required");
                const newChan = { 
                    ownerId: currentUserData.id, name: name, bio: bio, 
                    avatar: `https://cdn-icons-png.flaticon.com/512/2991/2991100.png`, 
                    cover: `https://cdn-icons-png.flaticon.com/512/3277/3277304.png`, 
                    followers: [],
                    timestamp: Date.now()
                };
                await addDoc(collection(db, "channels"), newChan); 
                document.getElementById('modal-create-channel').classList.remove('open'); 
            },

            handleSearch: function(query) {
                if(query.length < 2) { if(this.state.currentView === 'search') this.navTo('home'); return; }
                this.state.currentView = 'search';
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById('view-search').classList.add('active');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                this.renderSearch(query);
            },

            switchSearchTab: function(tab) {
                this.state.searchTab = tab;
                document.querySelectorAll('.s-tab').forEach(el => el.classList.remove('active'));
                event.target.classList.add('active');
                const query = document.querySelector('.search-input').value;
                this.renderSearch(query);
            },

            renderSearch: async function(query) {
                const list = document.getElementById('search-results-list'); 
                list.innerHTML = "<div style='padding:20px; color:#777; text-align:center'>Searching...</div>";
                
                try {
                    let results = [];
                    const lowerQuery = query.toLowerCase();
                    
                    // Search Users by Name (Starts with) OR Exact Username
                    const qUser = query(collection(db, "users"), where("name", ">=", query), where("name", "<=", query + "\uf8ff"));
                    const snapUser = await getDocs(qUser);
                    snapUser.forEach(doc => {
                        const u = doc.data();
                        results.push({
                            type: 'user', id: doc.id, name: u.name, sub: '@'+u.username, img: u.avatar
                        });
                    });
                    
                    // Also try exact username match
                    const qUserExact = query(collection(db, "users"), where("username", "==", lowerQuery));
                    const snapUserExact = await getDocs(qUserExact);
                    snapUserExact.forEach(doc => {
                        const u = doc.data();
                        // Avoid duplicate if found by name
                        if(!results.find(r => r.id === doc.id)) {
                             results.push({ type: 'user', id: doc.id, name: u.name, sub: '@'+u.username, img: u.avatar });
                        }
                    });

                    // Search Channels
                    const qChan = query(collection(db, "channels"), where("name", ">=", query), where("name", "<=", query + "\uf8ff"));
                    const snapChan = await getDocs(qChan);
                    snapChan.forEach(doc => {
                        const c = doc.data();
                        results.push({ type: 'channel', id: doc.id, name: c.name, sub: 'Channel', img: c.avatar });
                    });
                    
                    list.innerHTML = '';
                    if(results.length === 0) list.innerHTML = "<div style='padding:20px; color:#777; text-align:center'>No results found</div>";
                    
                    results.forEach(r => {
                        const badge = r.type === 'channel' ? `<span class="badge-channel">Channel</span>` : '';
                        const clickFn = r.type === 'channel' ? `app.openChannel('${r.id}')` : `app.openProfile('${r.id}')`;
                        
                        list.innerHTML += `
                        <div class="search-result-item" onclick="${clickFn}">
                            <img src="${r.img}" class="pc-avatar" ${r.type==='channel' ? "style='border-radius:8px;'" : ""}>
                            <div>
                                <div style="font-weight:bold;">${r.name} ${badge}</div>
                                <div style="color:var(--text-sec); font-size:13px;">${r.sub}</div>
                            </div>
                        </div>`;
                    });
                } catch(e) {
                    list.innerHTML = "<div style='padding:20px; color:#777; text-align:center'>Search failed</div>";
                }
            }
        };

        window.onload = () => app.init();
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.menu-btn') && !e.target.closest('.dropdown-menu')) {
                document.getElementById('main-menu').classList.remove('show');
            }
        });

        window.app = app;
    </script>
</body>
</html>
